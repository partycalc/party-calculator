<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Party Calculator — Final (Input Fix)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #111);
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #6b7280;
      --tg-theme-link-color: #2481cc;
      --tg-theme-button-color: #2481cc;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #f4f4f5;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--tg-theme-bg-color);
      border-bottom: 1px solid #e5e7eb;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .header-title { font-size: 17px; font-weight: 700; }

    /* Sticky tabs */
    .tabs-wrap {
      position: sticky;
      top: 48px; /* below header */
      z-index: 49;
      background: var(--tg-theme-bg-color);
      border-bottom: 1px solid #e5e7eb;
    }
    .tabs {
      display: flex;
      overflow-x: auto;
      gap: 2px;
      padding: 0 8px;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      flex: 0 0 auto;
      padding: 12px 10px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--tg-theme-hint-color);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }
    .tab.active {
      color: var(--tg-theme-link-color);
      border-bottom-color: var(--tg-theme-link-color);
    }

    .content { padding: 14px; }

    .section {
      background: var(--tg-theme-bg-color);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 12px;
      box-shadow: 0 0 0 1px #e5e7eb inset;
    }
    .section-header {
      padding: 10px 14px;
      background: var(--tg-theme-secondary-bg-color);
      color: var(--tg-theme-hint-color);
      text-transform: uppercase;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .02em;
    }

    .row { display: flex; gap: 8px; align-items:center; }
    .list-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 14px; border-top: 1px solid #e5e7eb;
    }
    .list-item:first-child { border-top: none; }
    .list-item-icon {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--tg-theme-link-color); color: #fff;
      display: flex; align-items: center; justify-content: center; font-weight: 700;
    }
    .list-item-title { font-size: 16px; font-weight: 600; }
    .list-item-subtitle { font-size: 13px; color: var(--tg-theme-hint-color); }
    .pill-amount { font-weight: 700; }

    .btn {
      padding: 13px 14px; border: none; border-radius: 10px; font-weight: 700;
      background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
      cursor: pointer;
    }
    .btn.full { width: 100%; }
    .btn.secondary { background: #34C759; }
    .btn.danger { background: #FF3B30; }

    .btn-small {
      padding: 6px 10px; border: 1px solid #e5e7eb; border-radius: 8px;
      background: var(--tg-theme-bg-color); font-size: 12px; cursor: pointer;
    }

    .form-input {
      width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 16px;
      background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color);
      min-width: 0;
    }

    .purchase-card {
      background: var(--tg-theme-secondary-bg-color);
      border-radius: 12px; padding: 12px; margin: 10px 12px;
      display: flex; gap: 12px; align-items: center;
    }
    .delete-btn {
      width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer;
      background: #FF3B30; color: #fff; font-size: 16px;
    }

    .result-card {
      background: var(--tg-theme-secondary-bg-color);
      border-radius: 12px; padding: 14px; margin: 12px;
    }
    .transfer-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; border-radius: 12px; padding: 16px; margin: 12px; text-align: center;
    }

    /* Consumption table */
    .consumption-wrap { overflow-x: auto; }
    .consumption-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; }
    .consumption-table th, .consumption-table td { border-bottom: 1px solid #e5e7eb; padding: 10px 8px; }
    .consumption-table thead th { background: var(--tg-theme-secondary-bg-color); vertical-align: bottom; }
    /* Sticky first column */
    .sticky-col {
      position: sticky; left: 0; z-index: 5;
      background: var(--tg-theme-bg-color);
    }

    .prod-head {
      display: flex; gap: 8px; align-items: center; justify-content: space-between;
      min-width: 180px;
    }
    .prod-title {
      display: inline-flex; flex-direction: column; align-items: flex-start; min-width: 0;
    }
    .prod-name {
      font-weight: 700; max-width: 48vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .prod-price {
      color: var(--tg-theme-hint-color); font-size: 12px; line-height: 1.2;
    }

    .status-ok { color: #34C759; font-weight: 700; font-size: 12px; }
    .status-warn { color: #FF9500; font-weight: 700; font-size: 12px; }
    .status-error { color: #FF3B30; font-weight: 700; font-size: 12px; }

    .cell-flex {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
    }
    .qty-input {
      width: 72px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; text-align: center;
    }
    .fraction { padding: 6px; font-size: 12px; border-radius: 6px; border: 1px solid #e5e7eb; background: var(--tg-theme-bg-color); }

    .developer-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; border-radius: 12px; padding: 20px; margin: 16px 0; text-align: center;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="header"><div class="header-title">Party Calculator</div></div>
  <div class="tabs-wrap">
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="participants">Участники</button>
      <button class="tab" data-tab="purchases">Покупки</button>
      <button class="tab" data-tab="consumption">Потребление</button>
      <button class="tab" data-tab="results">Результаты</button>
      <button class="tab" data-tab="help">Помощь</button>
    </div>
  </div>

  <div class="content">
    <div id="tab-participants"></div>
    <div id="tab-purchases" class="hidden"></div>
    <div id="tab-consumption" class="hidden"></div>
    <div id="tab-results" class="hidden"></div>
    <div id="tab-help" class="hidden"></div>
  </div>

<script>
(function () {
  const app = {
    data: { participants: [], purchases: [], consumption: {} },

    init() {
      this.loadData();
      if (window.Telegram && window.Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
      }
      // Tabs
      document.getElementById('tabs').addEventListener('click', (e) => {
        const t = e.target.closest('.tab');
        if (!t) return;
        this.showTab(t.dataset.tab, t);
      });
      this.render();
    },

    loadData() {
      try {
        const saved = localStorage.getItem('partyCalcData');
        if (saved) {
          const data = JSON.parse(saved);
          if (data.participants !== undefined) {
            const validPurchases = (data.purchases || []).filter(p =>
              (data.participants || []).some(part => part.id === p.buyerId)
            );
            this.data.participants = data.participants || [];
            this.data.purchases = validPurchases;
            this.data.consumption = data.consumption || {};
            return;
          }
        }
      } catch (e) {
        console.error('Error loading data:', e);
        localStorage.clear();
      }
      // defaults
      this.data.participants = [{id:1,name:'Иван'},{id:2,name:'Ольга'},{id:3,name:'Алексей'}];
      this.data.purchases = [{id:1,buyerId:1,item:'Пицца',price:400,quantity:2},{id:2,buyerId:2,item:'Вино',price:600,quantity:3}];
      this.data.consumption = {};
      this.saveData();
    },

    saveData() { localStorage.setItem('partyCalcData', JSON.stringify(this.data)); },

    showTab(tab, btnEl) {
      ['participants','purchases','consumption','results','help'].forEach(x => {
        document.getElementById('tab-'+x).classList.add('hidden');
      });
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-'+tab).classList.remove('hidden');
      if (btnEl) btnEl.classList.add('active');
      // keep table horizontal scroll
      if (tab === 'consumption') {
        const el = document.querySelector('.consumption-wrap');
        if (el && this._consScroll !== undefined) el.scrollLeft = this._consScroll;
      }
    },

    addParticipant() {
      const v = document.getElementById('new-participant').value.trim();
      if (!v) return;
      this.data.participants.push({id:Date.now(),name:v});
      document.getElementById('new-participant').value = '';
      this.saveData(); this.render();
    },

    deleteParticipant(id) {
      if (!confirm('Удалить участника?')) return;
      this.data.participants = this.data.participants.filter(p => p.id !== id);
      this.saveData(); this.render();
    },

    addPurchase() {
      if (!this.data.participants.length) { alert('Сначала добавьте участников!'); return; }
      const b = parseInt(document.getElementById('purchase-buyer').value);
      const i = document.getElementById('purchase-item').value.trim();
      const p = parseFloat(document.getElementById('purchase-price').value);
      const q = parseFloat(document.getElementById('purchase-quantity').value) || 1;
      if (!i || isNaN(p)) return;
      this.data.purchases.push({id:Date.now(),buyerId:b,item:i,price:p,quantity:q});
      // auto clear inputs
      document.getElementById('purchase-item').value = '';
      document.getElementById('purchase-price').value = '';
      document.getElementById('purchase-quantity').value = '';
      this.saveData(); this.render();
    },

    deletePurchase(id) {
      if (!confirm('Удалить покупку?')) return;
      this.data.purchases = this.data.purchases.filter(p => p.id !== id);
      this.saveData(); this.render();
    },

    getGroupedPurchases() {
      const groups = {};
      this.data.purchases.forEach(p => {
        const key = p.item + '-' + p.price;
        if (!groups[key]) {
          groups[key] = { key, item: p.item, price: p.price, totalQuantity: 0, purchases: [] };
        }
        groups[key].totalQuantity += p.quantity;
        groups[key].purchases.push(p);
      });
      return Object.values(groups);
    },

    getNameDupMap() {
      // map name -> count of distinct prices
      const map = {};
      this.data.purchases.forEach(p => {
        if (!map[p.item]) map[p.item] = new Set();
        map[p.item].add(p.price);
      });
      const res = {};
      Object.keys(map).forEach(name => res[name] = map[name].size);
      return res;
    },

    updateConsumption(gkey, uid, v) {
      const wrap = document.querySelector('.consumption-wrap');
      const scrollPos = wrap ? wrap.scrollLeft : 0;
      const val = parseFloat(v);
      this.data.consumption[gkey+'-'+uid] = isNaN(val) ? 0 : val;
      this.saveData();
      this.render();
      requestAnimationFrame(() => {
        const nw = document.querySelector('.consumption-wrap');
        if (nw) nw.scrollLeft = scrollPos;
      });
    },

    quickSet(gkey, uid, f, tot, cnt) {
      const wrap = document.querySelector('.consumption-wrap');
      const scrollPos = wrap ? wrap.scrollLeft : 0;
      let v = 0;
      if (f === '0') v = 0;
      else if (f === 'all') v = tot;
      else if (f.includes('/')) {
        const [n,d] = f.split('/').map(parseFloat);
        const already = this.data.participants.reduce((s, pa) => {
          if (pa.id === uid) return s;
          return s + (this.data.consumption[gkey+'-'+pa.id] || 0);
        }, 0);
        const remaining = tot - already;
        const exact = tot * n / d;
        v = Math.min(remaining, Math.round(exact * 100) / 100);
      }
      this.data.consumption[gkey+'-'+uid] = v;
      this.saveData();
      this.render();
      requestAnimationFrame(() => {
        const nw = document.querySelector('.consumption-wrap');
        if (nw) nw.scrollLeft = scrollPos;
      });
    },

    autoDistributePurchase(gkey) {
      const group = this.getGroupedPurchases().find(g => g.key === gkey);
      if (!group) return;
      const cnt = this.data.participants.length;
      const per = group.totalQuantity / cnt;
      let distributed = 0;
      this.data.participants.forEach((pa, i) => {
        if (i === cnt - 1) {
          this.data.consumption[group.key+'-'+pa.id] = Math.round((group.totalQuantity - distributed)*100)/100;
        } else {
          const share = Math.round(per*100)/100;
          this.data.consumption[group.key+'-'+pa.id] = share;
          distributed += share;
        }
      });
      this.saveData(); this.render();
    },

    autoDistributeAll() {
      if (!confirm('Распределить все продукты поровну?')) return;
      this.data.consumption = {};
      const groups = this.getGroupedPurchases();
      const cnt = this.data.participants.length;
      groups.forEach(group => {
        const per = group.totalQuantity / cnt;
        let distributed = 0;
        this.data.participants.forEach((pa, i) => {
          if (i === cnt - 1) {
            this.data.consumption[group.key+'-'+pa.id] = Math.round((group.totalQuantity - distributed)*100)/100;
          } else {
            const share = Math.round(per*100)/100;
            this.data.consumption[group.key+'-'+pa.id] = share;
            distributed += share;
          }
        });
      });
      this.saveData(); this.render();
    },

    clearConsumption() {
      if (!confirm('Очистить таблицу потребления?')) return;
      this.data.consumption = {};
      this.saveData(); this.render();
    },

    resetAll() {
      if (!confirm('Удалить ВСЕ данные и начать заново?')) return;
      localStorage.clear();
      this.data = { participants: [], purchases: [], consumption: {} };
      this.saveData(); this.render();
    },

    getConsumptionStatus(groupKey) {
      const group = this.getGroupedPurchases().find(g => g.key === groupKey);
      if (!group) return { filled: 0, total: 0, percent: 0, status: 'warn' };
      const filled = this.data.participants.reduce((sum, pa) => {
        const v = this.data.consumption[groupKey+'-'+pa.id] || 0;
        return sum + v;
      }, 0);
      const tot = group.totalQuantity;
      const percent = (filled / tot) * 100;
      let status = 'warn';
      if (percent > 100.5) status = 'error';
      else if (percent >= 99.5 && percent <= 100.5) status = 'ok';
      else status = 'warn';
      return { filled: Math.round(filled*100)/100, total: tot, percent, status };
    },

    calculateResults() {
      return this.data.participants.map(pa => {
        const spent = this.data.purchases
          .filter(p => p.buyerId === pa.id)
          .reduce((s,p)=> s + p.price*p.quantity, 0);
        const groups = this.getGroupedPurchases();
        const shouldPay = groups.reduce((s, g) => {
          const consumed = this.data.consumption[g.key+'-'+pa.id] || 0;
          return s + consumed * g.price;
        }, 0);
        return { id: pa.id, name: pa.name, spent, shouldPay, balance: spent - shouldPay };
      });
    },

    calculateTransfers() {
      const r = this.calculateResults();
      const deb = r.filter(x => x.balance < 0).sort((a,b)=> a.balance-b.balance);
      const cred = r.filter(x => x.balance > 0).sort((a,b)=> b.balance-a.balance);
      const tr = [];
      let i=0,j=0;
      while (i<deb.length && j<cred.length) {
        const amt = Math.min(Math.abs(deb[i].balance), cred[j].balance);
        if (amt > 0.01) tr.push({from: deb[i].name, to: cred[j].name, amount: Math.round(amt)});
        deb[i].balance += amt; cred[j].balance -= amt;
        if (Math.abs(deb[i].balance) < 0.01) i++;
        if (Math.abs(cred[j].balance) < 0.01) j++;
      }
      return tr;
    },

    exportResults() {
      const r = this.calculateResults();
      const tr = this.calculateTransfers();
      const tot = this.data.purchases.reduce((s,p)=> s + p.price*p.quantity, 0);

      let text = '📊 РАСЧЁТ РАСХОДОВ\n\n';
      text += '👥 Участники:\n';
      r.forEach(x => {
        text += `• ${x.name}: потратил ${Math.round(x.spent)}₽, должен ${Math.round(x.shouldPay)}₽\n`;
        text += `  Баланс: ${(x.balance>=0?'+':'')}${Math.round(x.balance)}₽\n`;
      });
      text += `\n💰 Общая сумма: ${Math.round(tot)}₽\n`;
      if (tr.length) {
        text += '\n💸 Кто кому должен:\n';
        tr.forEach(t => text += `• ${t.from} → ${t.to}: ${t.amount}₽\n`);
      }
      text += '\n📱 Рассчитано в Party Calculator';

      const share = async () => {
        try {
          if (navigator.share && window.Telegram && window.Telegram.WebApp) {
            await navigator.share({ text });
          } else if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            alert('✅ Результаты скопированы в буфер обмена!');
          } else {
            throw new Error('share/clipboard not available');
          }
        } catch(e) {
          // Fallback modal
          const modal = document.createElement('div');
          modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9999;padding:20px;overflow:auto';
          const box = document.createElement('div');
          box.style.cssText='background:#fff;border-radius:12px;max-width:520px;margin:40px auto;padding:16px';
          const ttl = document.createElement('div');
          ttl.style.cssText='font-weight:700;margin-bottom:8px'; ttl.textContent='📋 Скопируйте результаты';
          const ta = document.createElement('textarea');
          ta.value = text; ta.readOnly = true;
          ta.style.cssText='width:100%;height:260px;border:1px solid #e5e7eb;border-radius:8px;padding:10px;font-family:monospace';
          const btn = document.createElement('button');
          btn.className='btn full'; btn.style.marginTop='12px'; btn.textContent='Закрыть';
          btn.onclick=()=> document.body.removeChild(modal);
          box.append(ttl, ta, btn); modal.appendChild(box); document.body.appendChild(modal);
          ta.focus(); ta.select();
        }
      };
      share();
    },

    render() {
      this.renderParticipants();
      this.renderPurchases();
      this.renderConsumption();
      this.renderResults();
      this.renderHelp();
    },

    renderParticipants() {
      const r = this.calculateResults();
      let h = '<div class="section"><div class="section-header">Участники ('+this.data.participants.length+')</div>';
      this.data.participants.forEach(p => {
        const res = r.find(x => x.id === p.id) || {spent:0,balance:0};
        h += '<div class="list-item">';
        h += '<div class="list-item-icon">'+ (p.name[0]||'?').toUpperCase() +'</div>';
        h += '<div style="flex:1">';
        h += '<div class="list-item-title">'+ p.name +'</div>';
        h += '<div class="list-item-subtitle">Потратил '+ Math.round(res.spent) +'₽</div>';
        h += '</div>';
        h += '<div class="pill-amount" style="color:'+(res.balance>=0?'#34C759':'#FF3B30')+'">'+ (res.balance>=0?'+':'') + Math.round(res.balance) +'₽</div>';
        h += '<button class="delete-btn" onclick="APP.deleteParticipant('+p.id+')">🗑️</button>';
        h += '</div>';
      });
      h += '</div>';

      /* >>> FIXED 70/30 INPUT + BUTTON <<< */
      h += '<div class="row" style="margin-top:12px">';
      h += '<input id="new-participant" class="form-input" placeholder="Имя участника" style="flex:7; min-width:0;">';
      h += '<button class="btn" style="flex:3; padding:12px 10px;" onclick="APP.addParticipant()">Добавить</button>';
      h += '</div>';
      /* >>> END FIX <<< */

      h += '<div style="margin-top:12px;text-align:center">';
      h += '<button class="btn danger" style="width:auto" onclick="APP.resetAll()">🗑️ Сбросить все данные</button>';
      h += '</div>';
      document.getElementById('tab-participants').innerHTML = h;
    },

    renderPurchases() {
      const tot = this.data.purchases.reduce((s,p)=> s + p.price*p.quantity, 0);
      let h = '<div class="section"><div class="section-header">Новая покупка</div><div style="padding:14px">';
      if (!this.data.participants.length) {
        h += '<div style="text-align:center;color:var(--tg-theme-hint-color)">Сначала добавьте участников во вкладке «Участники»</div>';
      } else {
        h += '<div style="margin-bottom:12px"><label style="font-size:13px;font-weight:700;margin-bottom:6px;display:block">Кто купил?</label>';
        h += '<select id="purchase-buyer" class="form-input">';
        this.data.participants.forEach(p => h += '<option value="'+p.id+'">'+p.name+'</option>');
        h += '</select></div>';

        h += '<div style="margin-bottom:12px"><label style="font-size:13px;font-weight:700;margin-bottom:6px;display:block">Товар</label>';
        h += '<input id="purchase-item" class="form-input" placeholder="Напр. Пицца"></div>';

        h += '<div class="row" style="margin-bottom:12px">';
        h += '<div style="flex:1"><label style="font-size:13px;font-weight:700;margin-bottom:6px;display:block">Цена</label>';
        h += '<input id="purchase-price" type="number" inputmode="decimal" class="form-input" placeholder="0"></div>';
        h += '<div style="flex:1"><label style="font-size:13px;font-weight:700;margin-bottom:6px;display:block">Кол-во</label>';
        h += '<input id="purchase-quantity" type="number" inputmode="decimal" class="form-input" placeholder="1"></div>';
        h += '</div>';

        h += '<button class="btn full" onclick="APP.addPurchase()">Добавить</button>';
      }
      h += '</div></div>';

      if (this.data.purchases.length) {
        h += '<div class="section" style="margin-top:12px"><div class="section-header">Покупки ('+this.data.purchases.length+')</div>';
        this.data.purchases.forEach(p => {
          const b = this.data.participants.find(x => x.id === p.buyerId);
          if (!b) return;
          h += '<div class="purchase-card">';
          h += '<div style="flex:1">';
          h += '<div style="display:flex;justify-content:space-between;margin-bottom:6px">';
          h += '<span style="font-size:13px;color:var(--tg-theme-hint-color)">Купил: '+ (b?b.name:'?') +'</span>';
          h += '<span style="font-size:18px;font-weight:700;color:var(--tg-theme-link-color)">'+ Math.round(p.price*p.quantity) +'₽</span>';
          h += '</div>';
          h += '<div style="font-size:16px;font-weight:700">'+ p.item +'</div>';
          h += '<div style="font-size:13px;color:var(--tg-theme-hint-color)">'+ p.price +'₽ × '+ p.quantity +' шт</div>';
          h += '</div>';
          h += '<button class="delete-btn" onclick="APP.deletePurchase('+p.id+')">🗑️</button>';
          h += '</div>';
        });
        h += '</div>';
        h += '<div style="text-align:right;margin-top:8px;padding:12px;background:var(--tg-theme-secondary-bg-color);border-radius:12px">';
        h += '<div style="font-size:13px;color:var(--tg-theme-hint-color)">Всего</div>';
        h += '<div style="font-size:22px;font-weight:800;color:var(--tg-theme-link-color)">'+ Math.round(tot) +'₽</div>';
        h += '</div>';
      }
      document.getElementById('tab-purchases').innerHTML = h;
    },

    renderConsumption() {
      const groups = this.getGroupedPurchases();
      const nameDup = this.getNameDupMap();

      let h = '';
      h += '<div style="background:var(--tg-theme-secondary-bg-color);padding:12px;border-radius:12px;margin-bottom:12px">';
      h += '<div style="font-size:14px;font-weight:700;margin-bottom:8px">Быстрое распределение</div>';
      h += '<div class="row"><button class="btn-small" onclick="APP.autoDistributeAll()">Все поровну</button>';
      h += '<button class="btn-small" onclick="APP.clearConsumption()">Очистить всё</button></div></div>';

      h += '<div class="consumption-wrap">';
      h += '<table class="consumption-table"><thead><tr>';
      h += '<th class="sticky-col">Участник</th>';
      groups.forEach(g => {
        const st = this.getConsumptionStatus(g.key);
        let cls = 'status-warn', icon='⚠';
        if (st.status==='ok'){ cls='status-ok'; icon='✓'; }
        if (st.status==='error'){ cls='status-error'; icon='⚠'; }
        h += '<th>';
        h += '<div class="prod-head">';
        h += '<div class="prod-title">';
        h += '<span class="prod-name">'+ g.item +'</span>';
        if ((nameDup[g.item]||0) > 1) {
          h += '<span class="prod-price">('+ g.price +'₽)</span>';
        }
        h += '</div>';
        h += '<button class="btn-small" onclick="APP.autoDistributePurchase(\''+ g.key +'\')">Поровну</button>';
        h += '</div>';
        h += '<div class="'+cls+'">'+ icon +' '+ st.filled +' / '+ st.total +' шт';
        if (st.status==='error') h += ' (перебор!)';
        else if (st.status==='warn' && st.filled>0) h += ' (недозаполнено)';
        h += '</div>';
        h += '</th>';
      });
      h += '</tr></thead><tbody>';

      this.data.participants.forEach(pa => {
        h += '<tr>';
        h += '<td class="sticky-col" style="font-weight:700">'+ pa.name +'</td>';
        groups.forEach(g => {
          const k = g.key+'-'+pa.id;
          const v = this.data.consumption[k] || 0;
          const disp = v ? String(v) : ''; // пустое поле вместо "0"
          const cnt = this.data.participants.length;
          h += '<td><div class="cell-flex">';
          h += '<input class="qty-input" type="number" inputmode="decimal" placeholder="0" value="'+ disp +'" ';
          h += 'onchange="APP.updateConsumption(\''+ g.key +'\','+ pa.id +',this.value)">';
          // fraction select
          h += '<select class="fraction" onchange="if(this.value){APP.quickSet(\''+g.key+'\','+pa.id+',this.value,'+g.totalQuantity+','+cnt+'); this.value=\'\';}">';
          h += '<option value="">Доля</option><option value="0">Не ел</option>';
          for (let d=cnt; d>=2; d--) h+='<option value="1/'+d+'">1/'+d+'</option>';
          h += '<option value="all">Всё</option></select>';
          h += '</div></td>';
        });
        h += '</tr>';
      });

      h += '</tbody></table></div>';
      document.getElementById('tab-consumption').innerHTML = h;

      // remember horizontal scroll
      const wrap = document.querySelector('.consumption-wrap');
      wrap && wrap.addEventListener('scroll', () => this._consScroll = wrap.scrollLeft, { passive:true });
    },

    renderResults() {
      const r = this.calculateResults();
      const tr = this.calculateTransfers();
      let h = '<div class="section"><div class="section-header">Баланс</div>';
      r.forEach(x => {
        h += '<div class="result-card">';
        h += '<div style="font-size:18px;font-weight:800;margin-bottom:6px">'+ x.name +'</div>';
        h += '<div style="display:flex;justify-content:space-between;padding:6px 0"><span style="color:var(--tg-theme-hint-color)">Потратил</span><span style="font-weight:700)">'+ Math.round(x.spent) +'₽</span></div>';
        h += '<div style="display:flex;justify-content:space-between;padding:6px 0"><span style="color:var(--tg-theme-hint-color)">Должен</span><span style="font-weight:700)">'+ Math.round(x.shouldPay) +'₽</span></div>';
        h += '<div style="display:flex;justify-content:space-between;padding:6px 0"><span style="color:var(--tg-theme-hint-color)">Баланс</span><span style="font-weight:800;color:'+(x.balance>=0?'#34C759':'#FF3B30')+'">'+ (x.balance>=0?'+':'') + Math.round(x.balance) +'₽</span></div>';
        h += '</div>';
      });
      h += '</div>';

      if (tr.length) {
        h += '<div class="section" style="margin-top:12px"><div class="section-header">Переводы</div>';
        tr.forEach(t => {
          h += '<div class="transfer-card"><div>'+ t.from +' → '+ t.to +'</div>';
          h += '<div style="font-size:24px;font-weight:900;margin-top:6px">'+ t.amount +'₽</div></div>';
        });
        h += '</div>';
      }

      h += '<div style="margin-top:12px"><button class="btn secondary full" onclick="APP.exportResults()">📤 Поделиться результатами</button></div>';
      document.getElementById('tab-results').innerHTML = h;
    },

    renderHelp() {
      let h = '<div class="section"><div class="section-header">Как пользоваться</div><div style="padding:14px">';
      h += '<p>1) Добавьте участников.</p>';
      h += '<p>2) Внесите покупки.</p>';
      h += '<p>3) Распределите потребление в таблице.</p>';
      h += '<p>4) Откройте вкладку «Результаты» и поделитесь расчётом.</p>';
      h += '</div></div>';
      h += '<div class="developer-card">';
      h += '<div style="font-size:20px;font-weight:800;margin-bottom:8px">👨‍💻 Разработчик</div>';
      h += '<div style="font-size:18px;margin-bottom:4px">Владимир Васякин</div>';
      h += '<div style="font-size:16px;opacity:.9">📧 e@mailvladimir.ru</div>';
      h += '<div style="margin-top:10px;font-size:14px;opacity:.8">По вопросам и предложениям пишите на почту</div>';
      h += '</div>';
      document.getElementById('tab-help').innerHTML = h;
    }
  };

  // expose
  window.APP = app;
  window.onload = () => app.init();
})();
</script>
</body>
</html>
