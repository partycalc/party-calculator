<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Party Calculator</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      background:var(--tg-theme-bg-color,#0f172a);
      color:var(--tg-theme-text-color,#e5e7eb);
      -webkit-tap-highlight-color:transparent
    }
    :root{
      --tg-theme-bg-color:#0f172a;
      --tg-theme-text-color:#e5e7eb;
      --tg-theme-hint-color:#94a3b8;
      --tg-theme-link-color:#62aaff;
      --tg-theme-button-color:#3b82f6;
      --tg-theme-button-text-color:#fff;
      --tg-theme-secondary-bg-color:#0b1220;
    }

    .header{position:sticky;top:0;z-index:50;background:var(--tg-theme-bg-color);border-bottom:1px solid rgba(255,255,255,.06);padding:10px 16px;display:flex;justify-content:center}
    .header-title{font-size:17px;font-weight:700}

    .tabs-wrap{position:sticky;top:48px;z-index:49;background:var(--tg-theme-bg-color);border-bottom:1px solid rgba(255,255,255,.06)}
    .tabs{display:flex;overflow-x:auto;gap:2px;padding:0 8px;scrollbar-width:none}
    .tabs::-webkit-scrollbar{display:none}
    .tab{flex:0 0 auto;padding:12px 10px;background:none;border:none;border-bottom:2px solid transparent;color:inherit;opacity:.85;font-size:15px;font-weight:500;cursor:pointer;white-space:nowrap}
    .tab.active{color:var(--tg-theme-link-color);border-bottom-color:var(--tg-theme-link-color)}

    .content{padding:14px}
    .section{background:var(--tg-theme-secondary-bg-color);border-radius:16px;overflow:hidden;margin-bottom:12px;box-shadow:0 0 0 1px rgba(255,255,255,.06) inset}
    .section-header{padding:10px 14px;background:rgba(255,255,255,.04);color:#cbd5e1;text-transform:uppercase;font-weight:700;font-size:12px;letter-spacing:.02em}

    .row{display:flex;gap:8px;padding:10px}
    .col{flex:1}
    .input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:inherit;font-size:15px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:12px;padding:10px 14px;background:var(--tg-theme-button-color);color:var(--tg-theme-button-text-color);font-weight:700;cursor:pointer}
    .btn.secondary{background:rgba(255,255,255,.10);color:#e5e7eb}
    .btn.danger{background:#ef4444}
    .btn.small{padding:8px 10px;font-size:13px}

    .list{padding:8px 10px}
    .item{display:flex;align-items:flex-start;justify-content:space-between;padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.06);margin-bottom:8px;gap:12px;background:rgba(0,0,0,.1)}
    .item-title{font-weight:700}
    .item-sub{font-size:12px;color:var(--tg-theme-hint-color)}

    .table{width:100%;border-collapse:separate;border-spacing:0}
    .th,.td{border-bottom:1px solid rgba(255,255,255,.06);padding:10px}
    .th{font-size:12px;text-transform:uppercase;color:#94a3b8;background:rgba(255,255,255,.04);position:sticky;top:0;z-index:2}
    .sticky-left{position:sticky;left:0;background:var(--tg-theme-secondary-bg-color);z-index:1;border-right:1px solid rgba(255,255,255,.06)}

    .consumption-wrap{overflow-x:auto;border:1px solid rgba(255,255,255,.06);border-radius:16px}
    .qty-input{width:100%;padding:10px;border:1px solid rgba(255,255,255,.12);border-radius:10px;background:rgba(255,255,255,.06);color:inherit;text-align:center}
    .sum{font-weight:700}

    .hint{font-size:12px;color:var(--tg-theme-hint-color)}
    .link{color:var(--tg-theme-link-color);text-decoration:none}

    .results-card{border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px;margin-bottom:10px;background:rgba(0,0,0,.08)}
    .pos{color:#34d399;font-weight:700}
    .neg{color:#f87171;font-weight:700}

    /* DONATE modal */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:flex-end;z-index:60}
    .modal.show{display:flex}
    .sheet{background:var(--tg-theme-secondary-bg-color);border-radius:16px 16px 0 0;width:100%;padding:14px 14px 18px 14px;box-shadow:0 -8px 30px rgba(0,0,0,.4)}
    .sheet-title{font-weight:700;font-size:16px;margin-bottom:8px}
    .bank-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .bank-btn{border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;text-align:center;background:rgba(255,255,255,.06);color:#e5e7eb;cursor:pointer}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:rgba(255,255,255,.06);border:1px dashed rgba(255,255,255,.18);border-radius:12px;padding:10px 12px;margin-top:6px;color:#fff}

    /* видимый текст/каретка/плейсхолдер */
    .input,.qty-input{color:var(--tg-theme-text-color)!important;caret-color:var(--tg-theme-button-color)}
    .input::placeholder,.qty-input::placeholder{color:var(--tg-theme-hint-color);opacity:.95}

    /* потребление: адаптив */
    .consumption-desktop{display:block}
    .consumption-mobile{display:none}
    @media (max-width:520px){
      .consumption-desktop{display:none}
      .consumption-mobile{display:block}
      .consumption-mobile .item-title{margin-bottom:8px;display:block}
      .consumption-mobile .item{background:rgba(255,255,255,.04)}
    }
  </style>
</head>
<body>
  <div class="header"><div class="header-title">Party Calculator</div></div>
  <div class="tabs-wrap"><div class="tabs" id="tabs"></div></div>

  <div class="content">
    <div id="tab-participants"></div>
    <div id="tab-purchases" style="display:none"></div>
    <div id="tab-consumption" style="display:none"></div>
    <div id="tab-results" style="display:none"></div>
    <div id="tab-help" style="display:none"></div>
  </div>

  <!-- DONATE SHEET -->
  <div class="modal" id="donateModal">
    <div class="sheet">
      <div class="sheet-title">Поддержать разработку</div>
      <div class="hint">Перевод по СБП на номер:</div>
      <div class="code" id="donatePhone">+7 903 398-01-17</div>
      <div class="row" style="padding:10px 0 0 0">
        <button class="btn small" id="copyDonate">Скопировать номер</button>
        <button class="btn small secondary" id="closeDonate">Закрыть</button>
      </div>
      <div class="mt-12 text-sm">Быстрый запуск банка:</div>
      <div class="bank-grid">
        <div class="bank-btn" id="vtbBtn">ВТБ (СБП)</div>
        <div class="bank-btn" id="anyBankBtn">Любой банк (СБП)</div>
      </div>
      <div class="hint" style="margin-top:8px">Если банк не открылся автоматически — откройте ваше банковское приложение и сделайте «Перевод по номеру (СБП)».</div>
    </div>
  </div>

<script>
(function(){
  const LS_KEY = 'partycalc_v3';
  const CLOUD_PREFIX = 'pcv3_';
  const CLOUD_META = CLOUD_PREFIX + 'meta';
  const CLOUD_CHUNK = CLOUD_PREFIX + 'p';
  const CLOUD_CHUNK_SIZE = 3800;

  const DONATE_PHONE_RAW='79033980117';
  const DONATE_PHONE_VIEW='+7 903 398-01-17';
  const DEV_EMAIL='e@mailvladimir.ru';

  try{ if(window.Telegram&&Telegram.WebApp){ Telegram.WebApp.ready(); Telegram.WebApp.expand(); } }catch(_){}

  const uid=()=>Math.floor(Math.random()*1e9);
  // ⚠️ Без дефолтного «Я»
  const DEFAULT={
    participants:[],
    purchases:[],
    consumption:{},
    activeTab:'participants',
    updatedAt: Date.now()
  };

  const APP={
    data: DEFAULT,
    _consScroll:0,
    _saveTimer:null,

    async init(){
      await this.loadPersisted();
      this.renderTabs();
      this.render();
      this.initDonate();
    },

    /* ---------- Persistence ---------- */
    cloudAvailable(){ return !!(window.Telegram && Telegram.WebApp && Telegram.WebApp.CloudStorage); },
    cloudGet(key){ return new Promise(res=>{ try{ Telegram.WebApp.CloudStorage.getItem(key,(e,v)=>res(e?null:v)); }catch(_){ res(null); } }); },
    cloudSet(key,val){ return new Promise(res=>{ try{ Telegram.WebApp.CloudStorage.setItem(key,String(val),()=>res(true)); }catch(_){ res(false); } }); },

    async cloudLoad(){
      if(!this.cloudAvailable()) return null;
      const metaStr = await this.cloudGet(CLOUD_META);
      if(!metaStr) return null;
      let meta; try{ meta=JSON.parse(metaStr); }catch(_){ return null; }
      const parts = +meta.parts || 0;
      if(parts<=0) return null;
      let json=''; 
      for(let i=0;i<parts;i++){
        const chunk = await this.cloudGet(CLOUD_CHUNK+i);
        if(chunk==null){ json=null; break; }
        json += chunk;
      }
      if(!json) return null;
      try{ return JSON.parse(json); }catch(_){ return null; }
    },

    async cloudSave(){
      if(!this.cloudAvailable()) return;
      const json = JSON.stringify(this.data);
      const parts = Math.ceil(json.length / CLOUD_CHUNK_SIZE);
      for(let i=0;i<parts;i++){
        const slice = json.slice(i*CLOUD_CHUNK_SIZE, (i+1)*CLOUD_CHUNK_SIZE);
        await this.cloudSet(CLOUD_CHUNK+i, slice);
      }
      await this.cloudSet(CLOUD_META, JSON.stringify({parts, ts:this.data.updatedAt}));
    },
    cloudSaveDebounced(){
      clearTimeout(this._saveTimer);
      this._saveTimer = setTimeout(()=>{ this.cloudSave().catch(()=>{}); }, 350);
    },

    async loadPersisted(){
      let local=null; try{ local=JSON.parse(localStorage.getItem(LS_KEY)||'null'); }catch(_){}
      const cloud = await this.cloudLoad();

      const candidates=[local,cloud,DEFAULT].filter(Boolean);
      candidates.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
      this.data = candidates[0] || DEFAULT;

      // миграция: если единственный участник называется «Я» и покупок нет — убираем
      if (Array.isArray(this.data.participants)
          && this.data.participants.length===1
          && (this.data.participants[0].name||'').trim().toLowerCase()==='я'
          && (!Array.isArray(this.data.purchases) || this.data.purchases.length===0)) {
        this.data.participants = [];
      }

      if(!this.data.participants) this.data.participants=[];
      if(!this.data.purchases) this.data.purchases=[];
      if(!this.data.consumption) this.data.consumption={};
      if(!this.data.activeTab) this.data.activeTab='participants';
      if(!this.data.updatedAt) this.data.updatedAt=Date.now();

      try{ localStorage.setItem(LS_KEY, JSON.stringify(this.data)); }catch(_){}
    },

    saveData(){
      this.data.updatedAt = Date.now();
      try{ localStorage.setItem(LS_KEY, JSON.stringify(this.data)); }catch(_){}
      this.cloudSaveDebounced();
    },

    /* ---------- Tabs / Render ---------- */
    setTab(k){ this.data.activeTab=k; this.saveData(); this.renderTabs(); this.syncTabs(); this.render(); },
    renderTabs(){
      const tabs=[['participants','Участники'],['purchases','Покупки'],['consumption','Потребление'],['results','Результаты'],['help','Помощь']];
      const el=document.getElementById('tabs'); el.innerHTML='';
      tabs.forEach(([k,l])=>{ const b=document.createElement('button'); b.className='tab'+(this.data.activeTab===k?' active':''); b.textContent=l; b.onclick=()=>this.setTab(k); el.appendChild(b); });
    },
    syncTabs(){ ['participants','purchases','consumption','results','help'].forEach(k=>{ document.getElementById('tab-'+k).style.display=(this.data.activeTab===k)?'block':'none'; }); },
    render(){
      this.renderParticipants();
      this.renderPurchases();
      this.renderConsumption();
      this.renderResults();
      this.renderHelp();
    },

    /* ---------- Participants ---------- */
    renderParticipants(){
      const h=[];
      h.push('<div class="section"><div class="section-header">Участники ('+this.data.participants.length+')</div>');
      h.push('<div class="row"><div class="col"><input class="input" id="newPartName" placeholder="Имя участника"/></div><div class="flex gap-8"><button class="btn" id="addPart">Добавить</button><button class="btn secondary" id="resetAll">Сбросить</button></div></div>');
      h.push('<div class="list">');
      if(this.data.participants.length===0){
        h.push('<div class="item"><div class="hint">Начните с добавления участников.</div></div>');
      } else {
        this.data.participants.forEach(p=>{
          h.push('<div class="item"><div><div class="item-title">'+escapeHTML(p.name)+'</div></div><div class="flex gap-8"><button class="btn small secondary" data-edit="'+p.id+'">Переименовать</button><button class="btn small danger" data-del="'+p.id+'">Удалить</button></div></div>');
        });
      }
      h.push('</div></div>');
      const root=document.getElementById('tab-participants'); root.innerHTML=h.join('');

      document.getElementById('addPart').onclick=()=>{
        const v=document.getElementById('newPartName').value.trim(); if(!v) return;
        this.data.participants.push({id:uid(),name:v}); this.saveData(); this.render();
      };
      const resetBtn=document.getElementById('resetAll');
      if(resetBtn) resetBtn.onclick=()=>{ if(!confirm('Сбросить все данные?'))return; try{ localStorage.removeItem(LS_KEY);}catch(_){} this.data=JSON.parse(JSON.stringify(DEFAULT)); this.saveData(); this.setTab('participants'); };

      root.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>{
        const id=+b.getAttribute('data-edit'); const p=this.data.participants.find(x=>x.id===id); if(!p) return;
        const v=prompt('Новое имя',p.name); if(v&&v.trim()){ p.name=v.trim(); this.saveData(); this.render(); }
      });
      root.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{
        const id=+b.getAttribute('data-del');
        if(!confirm('Удалить участника и связанные данные?')) return;
        this.data.participants=this.data.participants.filter(x=>x.id!==id);
        this.data.purchases.forEach(it=>{ if(it.payerId===id) it.payerId=(this.data.participants[0]||{}).id; });
        const next={}; Object.keys(this.data.consumption).forEach(k=>{ const pid=+k.split('-')[1]; if(pid!==id) next[k]=this.data.consumption[k];}); this.data.consumption=next;
        this.saveData(); this.render();
      });
    },

    /* ---------- Purchases ---------- */
    renderPurchases(){
      const parts=this.data.participants; const h=[];
      h.push('<div class="section"><div class="section-header">Добавить покупку</div>');
      h.push('<div class="row"><div class="col"><input class="input" id="newItemTitle" placeholder="Товар (например: Пицца)"/></div><div style="width:110px"><input class="input" id="newItemAmt" placeholder="Цена, ₽" inputmode="decimal"/></div><div style="width:160px"><select class="input" id="newItemPayer"><option value="">Кто платил</option>');
      parts.forEach(p=>h.push('<option value="'+p.id+'">'+escapeHTML(p.name)+'</option>'));
      h.push('</select></div><div><button class="btn" id="addItem">Добавить</button></div></div>');

      h.push('<div class="section-header" style="border-top:1px solid rgba(255,255,255,.06)">Покупки ('+this.data.purchases.length+')</div><div class="list">');
      if(this.data.purchases.length===0){
        h.push('<div class="item"><div class="hint">Пока пусто.</div></div>');
      } else {
        this.data.purchases.forEach(it=>{
          const payer=parts.find(p=>p.id===it.payerId);
          h.push('<div class="item"><div><div class="item-title">'+escapeHTML(it.title)+'</div><div class="item-sub">Купил: '+(payer?escapeHTML(payer.name):'—')+'</div></div><div class="flex gap-8"><div class="item-title">'+fmt(it.amount)+'</div><button class="btn small secondary" data-edit="'+it.id+'">Изменить</button><button class="btn small danger" data-del="'+it.id+'">Удалить</button></div></div>');
        });
      }
      h.push('</div></div>');
      const root=document.getElementById('tab-purchases'); root.innerHTML=h.join('');

      document.getElementById('addItem').onclick=()=>{
        const t=document.getElementById('newItemTitle').value.trim();
        const a=parseNumber(document.getElementById('newItemAmt').value);
        const payerId=+document.getElementById('newItemPayer').value;
        if(parts.length===0) return alert('Сначала добавьте участников.');
        if(!t) return alert('Укажи товар.'); if(isNaN(a)||a<=0) return alert('Некорректная цена.'); if(!payerId) return alert('Выбери плательщика.');
        this.data.purchases.push({id:uid(),title:t,amount:a,payerId}); this.saveData(); this.render();
      };

      root.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{
        const id=+b.getAttribute('data-del'); if(!confirm('Удалить покупку?'))return;
        this.data.purchases=this.data.purchases.filter(x=>x.id!==id);
        const next={}; Object.keys(this.data.consumption).forEach(k=>{ if(+k.split('-')[0]!==id) next[k]=this.data.consumption[k];}); this.data.consumption=next;
        this.saveData(); this.render();
      });

      root.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>{
        const id=+b.getAttribute('data-edit'); const it=this.data.purchases.find(x=>x.id===id); if(!it) return;
        const t=prompt('Название',it.title) ?? it.title;
        const a=parseNumber(prompt('Цена, ₽',String(it.amount)) ?? it.amount);
        const payerName=prompt('Плательщик (имя, оставить пусто — без изменений)','');
        let payerId=it.payerId;
        if(payerName && payerName.trim()){
          const found=parts.find(p=>p.name.toLowerCase()===payerName.trim().toLowerCase());
          if(found) payerId=found.id; else alert('Такого участника нет. Плательщик не изменён.');
        }
        if(t&&t.trim()) it.title=t.trim();
        if(!isNaN(a)&&a>0) it.amount=a;
        it.payerId=payerId; this.saveData(); this.render();
      });
    },

    /* ---------- Consumption ---------- */
    renderConsumption(){
      const parts=this.data.participants, items=this.data.purchases, root=document.getElementById('tab-consumption');

      const cols=parts.map(p=>'<th class="th">'+escapeHTML(p.name)+'</th>').join('');
      let table='<div class="section consumption-desktop"><div class="section-header">Потребление по позициям</div><div class="consumption-wrap"><table class="table"><thead><tr><th class="th sticky-left">Позиция</th>'+cols+'<th class="th">Итого</th></tr></thead><tbody>';
      items.forEach(it=>{
        let row='<tr>';
        row+='<td class="td sticky-left"><div class="item-title">'+escapeHTML(it.title)+'</div><div class="item-sub">Сумма: '+fmt(it.amount)+'</div></td>';
        let sumRow=0;
        parts.forEach(p=>{
          const key=`${it.id}-${p.id}`, val=+this.data.consumption[key]||0; sumRow+=val;
          row+=`<td class="td"><input class="qty-input" data-key="${key}" type="number" inputmode="decimal" placeholder="0" value="${val||''}" onchange="APP.updateConsumption(${it.id},${p.id},this.value,this)"></td>`;
        });
        row+='<td class="td sum">'+(sumRow||0)+'</td></tr>'; table+=row;
      });
      if(items.length===0) table+='<tr><td class="td sticky-left" colspan="'+(parts.length+2)+'"><span class="hint">Добавьте покупки на вкладке «Покупки», затем распределите потребление.</span></td></tr>';
      table+='</tbody></table></div></div>';

      let cards='<div class="section consumption-mobile"><div class="section-header">Потребление</div><div class="list">';
      if(items.length===0) cards+='<div class="item"><div class="hint">Добавьте покупки на вкладке «Покупки».</div></div>';
      else items.forEach(it=>{
        let inner='<div class="item-sub">Сумма: '+fmt(it.amount)+'</div>';
        inner+='<div class="mt-8" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
        parts.forEach(p=>{
          const key=`${it.id}-${p.id}`, val=+this.data.consumption[key]||0;
          inner+=`<div><div class="item-sub" style="margin-bottom:4px">${escapeHTML(p.name)}</div><input class="qty-input" data-key="${key}" type="number" inputmode="decimal" placeholder="0" value="${val||''}" onchange="APP.updateConsumption(${it.id},${p.id},this.value,this)"></div>`;
        });
        inner+='</div>';
        cards+=`<div class="item"><div style="flex:1"><div class="item-title">${escapeHTML(it.title)}</div>${inner}</div></div>`;
      });
      cards+='</div></div>';

      root.innerHTML=table+cards;

      const wrap=root.querySelector('.consumption-wrap');
      if(wrap && typeof this._consScroll==='number') wrap.scrollLeft=this._consScroll;
      if(wrap && !this._consScrollListenerAdded){ wrap.addEventListener('scroll',()=>{this._consScroll=wrap.scrollLeft;},{passive:true}); this._consScrollListenerAdded=true; }
    },

    updateConsumption(itemId,partId,v,el){
      const wrap=document.querySelector('#tab-consumption .consumption-wrap');
      const saved=wrap?wrap.scrollLeft:0;
      const selS=el&&typeof el.selectionStart==='number'?el.selectionStart:null;
      const selE=el&&typeof el.selectionEnd==='number'?el.selectionEnd:null;

      const key=`${itemId}-${partId}`; const num=parseNumber(v);
      this.data.consumption[key]=isNaN(num)?0:num; this.saveData(); this.renderConsumption();

      requestAnimationFrame(()=>{
        const wrap2=document.querySelector('#tab-consumption .consumption-wrap'); if(wrap2) wrap2.scrollLeft=saved;
        const input2=document.querySelector(`input.qty-input[data-key="${key}"]`);
        if(input2){ input2.focus(); try{ if(selS!==null&&selE!==null) input2.setSelectionRange(selS,selE);}catch(_){} }
      });
    },

    /* ---------- Results ---------- */
    calculateResults(){
      const parts=this.data.participants, items=this.data.purchases, cons=this.data.consumption;
      const paid=Object.fromEntries(parts.map(p=>[p.id,0])); items.forEach(it=>{ if(paid[it.payerId]!=null) paid[it.payerId]+=it.amount; });
      const share=Object.fromEntries(parts.map(p=>[p.id,0]));
      items.forEach(it=>{
        let sum=0; parts.forEach(p=>{ sum+=(+cons[`${it.id}-${p.id}`]||0); });
        if(sum>0) parts.forEach(p=>{ const w=(+cons[`${it.id}-${p.id}`]||0); share[p.id]+=it.amount*(w/sum); });
        else { const n=parts.length||1; parts.forEach(p=>{ share[p.id]+=it.amount/n; }); }
      });
      const bal=Object.fromEntries(parts.map(p=>[p.id,+(paid[p.id]-share[p.id]).toFixed(2)]));

      const creditors=[],debtors=[];
      parts.forEach(p=>{ const b=+bal[p.id].toFixed(2); if(b>0) creditors.push({id:p.id,name:p.name,amt:b}); else if(b<0) debtors.push({id:p.id,name:p.name,amt:-b}); });
      creditors.sort((a,b)=>b.amt-a.amt); debtors.sort((a,b)=>b.amt-a.amt);
      const transfers=[]; let i=0,j=0;
      while(i<debtors.length&&j<creditors.length){
        const d=debtors[i],c=creditors[j]; const pay=+Math.min(d.amt,c.amt).toFixed(2);
        transfers.push({from:d,to:c,amt:pay}); d.amt=+(d.amt-pay).toFixed(2); c.amt=+(c.amt-pay).toFixed(2);
        if(d.amt<=0.009) i++; if(c.amt<=0.009) j++;
      }
      return {paid,share,bal,transfers};
    },

    renderResults(){
      const r=this.calculateResults(), parts=this.data.participants;
      const root=document.getElementById('tab-results');
      let h='<div class="section"><div class="section-header">Итоги и взаиморасчёты</div><div class="list" id="results-capture">';
      if(parts.length===0){
        h+='<div class="item"><div class="hint">Добавьте участников и покупки, чтобы увидеть итоги.</div></div>';
      }else{
        parts.forEach(p=>{
          const b=+r.bal[p.id];
          h+='<div class="results-card"><div class="item-title">'+escapeHTML(p.name)+'</div>';
          h+='<div class="item-sub">Оплатил: '+fmt(r.paid[p.id])+' | Его доля: '+fmt(r.share[p.id])+'</div>';
          h+='<div class="'+(b>=0?'pos':'neg')+'">Баланс: '+fmt(b)+'</div></div>';
        });
      }
      h+='<div class="section-header" style="margin:12px -14px 0 -14px">Кто кому переводит</div><div class="list">';
      if(r.transfers.length===0) h+='<div class="item"><div>Никто никому не должен 🎉</div></div>';
      else r.transfers.forEach(t=>{ h+='<div class="item"><div>'+escapeHTML(t.from.name)+' → '+escapeHTML(t.to.name)+'</div><div class="sum">'+fmt(t.amt)+'</div></div>'; });
      h+='</div>';
      h+='<div class="row" style="padding:12px 10px"><button class="btn" id="btnSavePng">Сохранить PNG</button><button class="btn secondary" id="btnShare">Поделиться</button></div>';
      h+='</div></div>';
      root.innerHTML=h;

      document.getElementById('btnSavePng').onclick=()=>this.saveResultsAsImage();
      document.getElementById('btnShare').onclick=()=>this.shareResults();
    },

    saveResultsAsImage(){
      const node=document.getElementById('results-capture'); if(!node) return alert('Не найден блок результатов');
      const bg=getComputedStyle(document.body).backgroundColor || '#ffffff';
      html2canvas(node,{scale:2,backgroundColor:bg,useCORS:true,removeContainer:true,windowWidth:document.documentElement.scrollWidth})
      .then(canvas=>{
        if(canvas.toBlob){
          canvas.toBlob(blob=>{
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a'); a.href=url; a.download='party-result.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          });
        }else{
          const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='party-result.png'; a.click();
        }
      }).catch(()=>alert('Не удалось сохранить картинку.'));
    },

    shareResults(){
      const r=this.calculateResults(), parts=this.data.participants;
      let text='Итоги Party Calculator:\n\n';
      parts.forEach(p=>{
        const b=+r.bal[p.id];
        text+=`${p.name}: оплатил ${fmt(r.paid[p.id])}, доля ${fmt(r.share[p.id])}, баланс ${fmt(b)}\n`;
      });
      if(r.transfers.length){
        text+='\nПереводы:\n';
        r.transfers.forEach(t=>{ text+=`• ${t.from.name} → ${t.to.name}: ${fmt(t.amt)}\n`; });
      }else{
        text+='\nНикто никому не должен 🎉\n';
      }

      if(navigator.share){
        navigator.share({text}).catch(()=>this.copyText(text));
      }else{
        this.copyText(text);
      }
    },
    copyText(t){
      navigator.clipboard?.writeText(t).then(()=>alert('Текст скопирован. Откройте мессенджер и вставьте.')).catch(()=>alert('Скопируйте вручную: '+t));
    },

    /* ---------- Help ---------- */
    renderHelp(){
      const h=`
        <div class="section">
          <div class="section-header">Как пользоваться</div>
          <div class="list">
            <div class="item"><div><div class="item-title">📝 Шаг 1: Добавьте участников</div><div class="item-sub">Во вкладке «Участники» внесите имена всех участников. Можно добавлять и удалять в любой момент.</div></div></div>
            <div class="item"><div><div class="item-title">🛒 Шаг 2: Внесите покупки</div><div class="item-sub">Укажите покупателя, товар и цену.</div></div></div>
            <div class="item"><div><div class="item-title">🍕 Шаг 3: Распределите потребление</div><div class="item-sub">В «Потреблении» укажите кто сколько съел/выпил, либо распределите поровну.</div></div></div>
            <div class="item"><div><div class="item-title">💰 Шаг 4: Результаты</div><div class="item-sub">Баланс по каждому и список переводов. Нажмите «Сохранить PNG» или «Поделиться».</div></div></div>

            <div class="item" style="background:linear-gradient(135deg,#5b7cff,#9d6bff);color:#fff">
              <div style="flex:1">
                <div class="item-title">👨‍💻 Разработчик</div>
                <div class="item-sub" style="color:#eaf2ff">Владимир Васякин</div>
                <div class="item-sub"><a class="link" href="#" id="devEmailLink" style="color:#fff;text-decoration:underline">e@mailvladimir.ru</a></div>
                <div class="item-sub" style="color:#eaf2ff">По вопросам и предложениям — пишите на почту</div>
              </div>
              <button class="btn small secondary" id="openDonate2" style="background:rgba(255,255,255,.2);color:#fff">Донат</button>
            </div>
          </div>
        </div>`;
      const root=document.getElementById('tab-help'); root.innerHTML=h;
      document.getElementById('openDonate2').onclick=()=>this.showDonateModal(true);
      document.getElementById('devEmailLink').onclick=(e)=>{ e.preventDefault(); this.openMail(); };
    },

    /* ---------- Donate / SBP ---------- */
    initDonate(){
      const modal=document.getElementById('donateModal');
      modal?.addEventListener('click',(e)=>{ if(e.target===modal) this.showDonateModal(false); });
      const closeBtn=document.getElementById('closeDonate'); closeBtn && (closeBtn.onclick=()=>this.showDonateModal(false));

      const copyBtn=document.getElementById('copyDonate');
      copyBtn && (copyBtn.onclick=async()=>{ try{ await navigator.clipboard.writeText(DONATE_PHONE_RAW); alert('Номер скопирован: '+DONATE_PHONE_VIEW);}catch{ alert('Скопируйте номер вручную: '+DONATE_PHONE_VIEW);} });

      const anyBtn=document.getElementById('anyBankBtn');
      anyBtn && (anyBtn.onclick=()=>{ alert('В вашем банке выберите «Перевод по номеру (СБП)» и вставьте: '+DONATE_PHONE_VIEW); });

      const vtbBtn=document.getElementById('vtbBtn'); vtbBtn && (vtbBtn.onclick=()=>this.tryVTB());
    },
    showDonateModal(show){ const m=document.getElementById('donateModal'); if(!m) return; m.classList.toggle('show',!!show); },

    openUrl(url){
      try{ if(window.Telegram?.WebApp?.openLink){ Telegram.WebApp.openLink(url); return; } }catch(_){}
      const w=window.open(url,'_blank'); if(!w) location.href=url;
    },

    tryVTB(){
      const phone=DONATE_PHONE_RAW;
      const candidates=[
        'vtb://sbp?phone='+phone,
        'vtb://pay?phone='+phone,
        'intent://sbp?phone='+phone+'#Intent;scheme=vtb;package=ru.vtb24.mobilebanking.android;end',
        'intent://pay?phone='+phone+'#Intent;scheme=sbp;package=ru.vtb24.mobilebanking.android;end'
      ];
      let opened=false;
      for(const u of candidates){ try{ this.openUrl(u); opened=true; break; }catch(_){} }
      setTimeout(()=>{ if(!opened) this.openUrl('https://www.vtb.ru/personal/servisy/sistema-bystryh-platezhey/'); alert('Откройте приложение ВТБ → «Перевод по номеру (СБП)» → вставьте '+DONATE_PHONE_VIEW); },600);
    },

    openMail(){
      const mailto=`mailto:${encodeURIComponent(DEV_EMAIL)}?subject=${encodeURIComponent('Party Calculator — вопрос/идея')}`;
      try{
        if(window.Telegram?.WebApp?.openLink){ Telegram.WebApp.openLink(mailto); return; }
      }catch(_){}
      const w=window.open(mailto,'_blank');
      if(!w){
        navigator.clipboard?.writeText(DEV_EMAIL);
        alert('Если почтовое приложение не открылось — адрес скопирован: '+DEV_EMAIL);
      }
    }
  };

  /* ---------- Helpers ---------- */
  function parseNumber(v){ if(typeof v==='number') return v; if(!v) return NaN; const s=String(v).replace(',', '.').replace(/\s+/g,''); return parseFloat(s); }
  function fmt(n){ const s=(typeof n==='number'?n:parseNumber(n)); if(isNaN(s)) return '—'; return s.toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  window.APP=APP; window.onload=()=>APP.init();
})();
</script>
</body>
</html>
