<!DOCTYPE html>
<html lang="ru">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport"/>
  <title>
   Party Calculator
  </title>
  <link href="manifest.json" rel="manifest"/>
  <meta content="#2481cc" name="theme-color"/>
  <link href="icon-192.png" rel="icon" type="image/png"/>
  <script src="https://telegram.org/js/telegram-web-app.js">
  </script>
  <style>
   * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      padding-bottom: 20px;
    }
    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #999999;
      --tg-theme-link-color: #2481cc;
      --tg-theme-button-color: #2481cc;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #f4f4f5;
    }
    .header { background: var(--tg-theme-bg-color); padding: 12px 16px; border-bottom: 1px solid #e5e5ea; position: sticky; top: 0; z-index: 100; }
    .header-title { font-size: 17px; font-weight: 600; text-align: center; }
    .tabs { display: flex; background: var(--tg-theme-secondary-bg-color); border-bottom: 1px solid #e5e5ea; overflow-x: auto; position: sticky; top: 44px; z-index: 99; }
    .tab { flex: 1; min-width: 80px; padding: 12px; text-align: center; background: none; border: none; font-size: 15px; color: var(--tg-theme-hint-color); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
    .tab.active { color: var(--tg-theme-link-color); border-bottom-color: var(--tg-theme-link-color); font-weight: 500; }
    .content { padding: 16px; }
    .section { background: var(--tg-theme-bg-color); border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
    .section-header { padding: 12px 16px; background: var(--tg-theme-secondary-bg-color); font-size: 13px; font-weight: 600; color: var(--tg-theme-hint-color); text-transform: uppercase; }
    .list-item { padding: 12px 16px; border-bottom: 1px solid #e5e5ea; display: flex; align-items: center; gap: 12px; }
    .list-item:last-child { border-bottom: none; }
    .list-item-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--tg-theme-link-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .list-item-content { flex: 1; }
    .list-item-title { font-size: 16px; font-weight: 500; }
    .list-item-subtitle { font-size: 14px; color: var(--tg-theme-hint-color); }
    .purchase-card { background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 12px; margin: 8px; display: flex; gap: 12px; align-items: center; }
    .delete-btn { width: 36px; height: 36px; border-radius: 50%; background: #FF3B30; color: white; border: none; cursor: pointer; }
    .btn { padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); width: 100%; }
    .btn-secondary { background: #34C759; color: white; width: 100%; }
    .btn-small { padding: 6px 12px; font-size: 13px; border-radius: 6px; border: 1px solid #e5e5ea; background: var(--tg-theme-bg-color); cursor: pointer; }
    .form-input { width: 100%; padding: 12px; border: 1px solid #e5e5ea; border-radius: 10px; font-size: 16px; }
    .hidden { display: none; }
    .result-card { background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 16px; margin: 12px; }
    .transfer-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 16px; margin: 12px; text-align: center; }
    .status-ok { color: #34C759; font-weight: 600; }
    .status-warn { color: #FF9500; font-weight: 600; }
    .status-error { color: #FF3B30; font-weight: 600; }
    .faq-item { background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .faq-question { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--tg-theme-link-color); }
    .faq-answer { font-size: 14px; line-height: 1.5; color: var(--tg-theme-text-color); }
    .developer-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 20px; margin: 16px 0; text-align: center; }
    /* Sticky first column for consumption table */
    .sticky-col { position: sticky; left: 0; background: var(--tg-theme-bg-color); z-index: 2; }
  </style>
 </head>
 <body>
  <div class="header">
   <div class="header-title">
    Party Calculator
   </div>
  </div>
  <div class="tabs">
   <button class="tab active" onclick="app.showTab(event,'participants')">
    &Ucy;&chcy;&acy;&scy;&tcy;&ncy;&icy;&kcy;&icy;
   </button>
   <button class="tab" onclick="app.showTab(event,'purchases')">
    &Pcy;&ocy;&kcy;&ucy;&pcy;&kcy;&icy;
   </button>
   <button class="tab" onclick="app.showTab(event,'consumption')">
    &Pcy;&ocy;&tcy;&rcy;&iecy;&bcy;&lcy;&iecy;&ncy;&icy;&iecy;
   </button>
   <button class="tab" onclick="app.showTab(event,'results')">
    &Rcy;&iecy;&zcy;&ucy;&lcy;&softcy;&tcy;&acy;&tcy;&ycy;
   </button>
   <button class="tab" onclick="app.showTab(event,'help')">
    &Pcy;&ocy;&mcy;&ocy;&shchcy;&softcy;
   </button>
  </div>
  <div class="content">
   <div id="tab-participants">
   </div>
   <div class="hidden" id="tab-purchases">
   </div>
   <div class="hidden" id="tab-consumption">
   </div>
   <div class="hidden" id="tab-results">
   </div>
   <div class="hidden" id="tab-help">
   </div>
  </div>
  <!-- Основной JS -->
  <script>
   var app = {
      data: { participants: [], purchases: [], consumption: {} },

      init: function() {
        this.loadData();
        if (window.Telegram && window.Telegram.WebApp) {
          window.Telegram.WebApp.ready();
          window.Telegram.WebApp.expand();
        }
        this.render();
      },

      loadData: function() {
        try {
          const saved = localStorage.getItem('partyCalcData');
          if (saved) {
            const data = JSON.parse(saved);
            if (data.participants !== undefined) {
              const validPurchases = data.purchases ? data.purchases.filter(function(p) {
                return data.participants.some(function(part) { return part.id === p.buyerId; });
              }) : [];
              this.data.participants = data.participants || [];
              this.data.purchases = validPurchases;
              this.data.consumption = data.consumption || {};
              return;
            }
          }
        } catch(e) {
          console.error('Ошибка загрузки данных:', e);
          localStorage.clear();
        }
        this.data.participants = [
          {id:1,name:'Алексей'},
          {id:2,name:'Мария'},
          {id:3,name:'Иван'},
          {id:4,name:'Ольга'}
        ];
        this.data.purchases = [
          {id:1,buyerId:1,item:'Пицца',price:400,quantity:3},
          {id:2,buyerId:2,item:'Вино',price:600,quantity:5}
        ];
        this.data.consumption = {};
        this.saveData();
      },

      saveData: function() {
        localStorage.setItem('partyCalcData', JSON.stringify(this.data));
      },

      showTab: function(e, t) {
        ['participants','purchases','consumption','results','help'].forEach(function(x) {
          document.getElementById('tab-'+x).classList.add('hidden');
        });
        document.querySelectorAll('.tab').forEach(function(b) {
          b.classList.remove('active');
        });
        document.getElementById('tab-'+t).classList.remove('hidden');
        if (e && e.target) e.target.classList.add('active');
      },

      addParticipant: function() {
        const v = document.getElementById('new-participant').value.trim();
        if (!v) return;
        this.data.participants.push({id:Date.now(),name:v});
        document.getElementById('new-participant').value = '';
        this.saveData(); this.render();
      },

      deleteParticipant: function(id) {
        if (!confirm('Удалить?')) return;
        this.data.participants = this.data.participants.filter(function(p) { return p.id !== id; });
        this.saveData(); this.render();
      },

      addPurchase: function() {
        if (!this.data.participants.length) {
          alert('Сначала добавьте участников!');
          return;
        }
        const b = parseInt(document.getElementById('purchase-buyer').value);
        const i = document.getElementById('purchase-item').value.trim();
        const p = parseFloat(document.getElementById('purchase-price').value);
        const q = parseFloat(document.getElementById('purchase-quantity').value) || 1;
        if (!i || isNaN(p)) return;
        this.data.purchases.push({id:Date.now(),buyerId:b,item:i,price:p,quantity:q});
        document.getElementById('purchase-item').value = '';
        document.getElementById('purchase-price').value = '';
        document.getElementById('purchase-quantity').value = '';
        document.getElementById('purchase-price').value = '';
        document.getElementById('purchase-quantity').value = '1';
        this.saveData(); this.render();
      },

      deletePurchase: function(id) {
        if (!confirm('Удалить?')) return;
        this.data.purchases = this.data.purchases.filter(function(p) { return p.id !== id; });
        this.saveData(); this.render();
      },

      getGroupedPurchases: function() {
        const groups = {};
        this.data.purchases.forEach(function(p) {
          const key = p.item + '-' + p.price;
          if (!groups[key]) {
            groups[key] = { key:key, item:p.item, price:p.price, totalQuantity:0, purchases:[] };
          }
          groups[key].totalQuantity += p.quantity;
          groups[key].purchases.push(p);
        });
        return Object.values(groups);
      },

      getConsumptionStatus: function(groupKey) {
        const group = this.getGroupedPurchases().find(function(g){ return g.key === groupKey; });
        if (!group) return { filled: 0, total: 0, percent: 0, status: 'warn' };
        const filled = this.data.participants.reduce((sum, pa)=>{
          const val = app.data.consumption[groupKey+'-'+pa.id];
          return sum + (val ? parseFloat(val) : 0);
        },0);
        const total = group.totalQuantity;
        const percent = total ? (filled / total) * 100 : 0;
        let status = 'warn';
        if (percent > 100.5) status = 'error';
        else if (percent >= 99.5 && percent <= 100.5) status = 'ok';
        else status = 'warn';
        return { filled: Math.round(filled*100)/100, total: total, percent: percent, status: status };
      },

      updateConsumption: function(gkey, uid, v) {
        this.data.consumption[gkey+'-'+uid] = parseFloat(v) || 0;
        this.saveData(); this.render();
      },

      quickSet: function(gkey, uid, f, tot, cnt) {
        let v = 0;
        if (f === '0') v = 0;
        else if (f === 'all') v = tot;
        else if (f.includes('/')) {
          const parts = f.split('/');
          const n = parseFloat(parts[0]);
          const d = parseFloat(parts[1]);
          const already = this.data.participants.reduce((s,pa)=> s+(pa.id===uid?0:(this.data.consumption[gkey+'-'+pa.id]||0)),0);
          const remaining = tot - already;
          const exact = tot * n / d;
          v = Math.min(remaining, Math.round(exact*100)/100);
        }
        this.data.consumption[gkey+'-'+uid] = v;
        this.saveData(); this.render();
      },

      autoDistributePurchase: function(gkey) {
        const group = this.getGroupedPurchases().find(g=>g.key===gkey);
        if (!group) return;
        const cnt = this.data.participants.length;
        const per = group.totalQuantity/cnt;
        let dist = 0;
        this.data.participants.forEach((pa,i)=>{
          if (i===cnt-1) this.data.consumption[group.key+'-'+pa.id] = Math.round((group.totalQuantity-dist)*100)/100;
          else { const s=Math.round(per*100)/100; this.data.consumption[group.key+'-'+pa.id]=s; dist+=s; }
        });
        this.saveData(); this.render();
      },

      autoDistribute: function() {
        if (!confirm('Распределить ВСЕ продукты поровну?')) return;
        this.data.consumption = {};
        this.getGroupedPurchases().forEach(group=>{
          const cnt=this.data.participants.length;
          const per=group.totalQuantity/cnt; let dist=0;
          this.data.participants.forEach((pa,i)=>{
            if (i===cnt-1) this.data.consumption[group.key+'-'+pa.id]=Math.round((group.totalQuantity-dist)*100)/100;
            else { const s=Math.round(per*100)/100; this.data.consumption[group.key+'-'+pa.id]=s; dist+=s; }
          });
        });
        this.saveData(); this.render();
      },

      clearConsumption: function() {
        if (!confirm('Очистить таблицу потребления?')) return;
        this.data.consumption={}; this.saveData(); this.render();
      },

      resetAll: function() {
        if (!confirm('Удалить ВСЕ данные и начать заново? Это действие нельзя отменить!')) return;
        localStorage.clear();
        this.data={participants:[],purchases:[],consumption:{}}; this.saveData(); this.render();
      },

      calculateResults: function() {
        return this.data.participants.map(pa=>{
          const spent=this.data.purchases.filter(p=>p.buyerId===pa.id).reduce((s,p)=>s+p.price*p.quantity,0);
          const should=this.getGroupedPurchases().reduce((s,g)=> s+( (this.data.consumption[g.key+'-'+pa.id]||0)*g.price),0);
          return {id:pa.id,name:pa.name,spent:spent,shouldPay:should,balance:spent-should};
        });
      },

      calculateTransfers: function() {
        const r=this.calculateResults();
        const deb=r.filter(x=>x.balance<0).sort((a,b)=>a.balance-b.balance);
        const cred=r.filter(x=>x.balance>0).sort((a,b)=>b.balance-a.balance);
        const tr=[]; let i=0,j=0;
        while(i<deb.length&&j<cred.length){
          const amt=Math.min(Math.abs(deb[i].balance),cred[j].balance);
          if(amt>0.01) tr.push({from:deb[i].name,to:cred[j].name,amount:Math.round(amt)});
          deb[i].balance+=amt; cred[j].balance-=amt;
          if(Math.abs(deb[i].balance)<0.01)i++;
          if(Math.abs(cred[j].balance)<0.01)j++;
        }
        return tr;
      },

      exportResults: function() {
        const r = this.calculateResults();
        const tr = this.calculateTransfers();
        const tot = this.data.purchases.reduce((s,p)=>s+p.price*p.quantity,0);

        let text = '💰 Общий чек: ' + Math.round(tot) + '₽\n\n';
        text += '👥 Участники:\n';
        r.forEach(x=>{
          text += '• ' + x.name + '\n';
          text += '  Употребил: ' + Math.round(x.shouldPay) + '₽\n';
          text += '  Потратил: ' + Math.round(x.spent) + '₽\n';
          text += '  Баланс: ' + (x.balance>=0?'+':'') + Math.round(x.balance) + '₽\n\n';
        });

        if(tr.length){ 
          text += '💸 Итоги переводов:\n';
          tr.forEach(t=>{ text += '• ' + t.from + ' → ' + t.to + ': ' + t.amount + '₽\n'; });
        }

        text += '\n📱 Рассчитано в Party Calculator';

        if(navigator.share){
          navigator.share({text:text});
        } else if(navigator.clipboard){
          navigator.clipboard.writeText(text).then(()=>alert('Результаты скопированы в буфер обмена!'));
        } else {
          const ta=document.createElement('textarea');
          ta.value=text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          alert('Результаты скопированы!');
        }
      },
      render: function(){
        this.renderParticipants(); this.renderPurchases(); this.renderConsumption(); this.renderResults(); this.renderHelp();
      },

      renderParticipants: function() {
        const r=this.calculateResults();
        let h='<div class="section"><div class="section-header">Участники ('+this.data.participants.length+')</div>';
        this.data.participants.forEach(p=>{
          const res=r.find(x=>x.id===p.id)||{spent:0,balance:0};
          h+='<div class="list-item">'
            +'<div class="list-item-icon">'+(p.name?p.name[0].toUpperCase():'?')+'</div>'
            +'<div class="list-item-content">'
              +'<div class="list-item-title">'+p.name+'</div>'
              +'<div class="list-item-subtitle">Потратил '+Math.round(res.spent)+'₽</div>'
            +'</div>'
            +'<div style="font-size:16px;font-weight:600;color:'+(res.balance>=0?'#34C759':'#FF3B30')+'">'
              +(res.balance>=0?'+':'')+Math.round(res.balance)+'₽'
            +'</div>'
            +'<button class="delete-btn" onclick="app.deleteParticipant('+p.id+')">🗑️</button>'
          +'</div>';
        });
        h+='</div>'
          +'<div style="display:flex;gap:8px;margin-top:12px">'
            +'<input type="text" id="new-participant" class="form-input" placeholder="Имя участника">'
            +'<button class="btn btn-primary" style="width:auto;padding:12px 24px" onclick="app.addParticipant()">+</button>'
          +'</div>'
          +'<div style="margin-top:12px;text-align:center">'
            +'<button onclick="app.resetAll()" style="padding:8px 16px;background:#FF3B30;color:white;border:none;border-radius:8px;font-size:14px;cursor:pointer">🗑️ Сбросить все данные</button>'
          +'</div>';
        document.getElementById('tab-participants').innerHTML=h;
      },

      renderPurchases: function() {
        const tot=this.data.purchases.reduce((s,p)=>s+p.price*p.quantity,0);
        let h='<div class="section"><div class="section-header">Новая покупка</div><div style="padding:16px">';
        if(!this.data.participants.length){
          h+='<div style="padding:20px;text-align:center;color:var(--tg-theme-hint-color)">Сначала добавьте участников на вкладке "Участники"</div>';
        } else {
          h+='<div style="margin-bottom:16px"><label style="display:block;font-size:14px;font-weight:500;margin-bottom:8px">Кто купил?</label>'
            +'<select id="purchase-buyer" class="form-input">';
          this.data.participants.forEach(p=>{ h+='<option value="'+p.id+'">'+p.name+'</option>'; });
          h+='</select></div>'
            +'<div style="margin-bottom:16px"><label style="display:block;font-size:14px;font-weight:500;margin-bottom:8px">Товар</label>'
            +'<input type="text" id="purchase-item" class="form-input" placeholder="Пицца"></div>'
            +'<div style="display:flex;gap:12px;margin-bottom:16px">'
              +'<div style="flex:1"><label style="display:block;font-size:14px;font-weight:500;margin-bottom:8px">Цена</label>'
              +'<input type="number" id="purchase-price" class="form-input" placeholder="0"></div>'
              +'<div style="flex:1"><label style="display:block;font-size:14px;font-weight:500;margin-bottom:8px">Кол-во</label>'
              +'<input type="number" id="purchase-quantity" class="form-input" value="1" step="0.1"></div>'
            +'</div>'
            +'<button class="btn btn-primary" onclick="app.addPurchase()">Добавить</button>';
        }
        h+='</div></div>';
        if(this.data.purchases.length>0){
          h+='<div class="section" style="margin-top:16px"><div class="section-header">Покупки ('+this.data.purchases.length+')</div>';
          this.data.purchases.forEach(p=>{
            const b=this.data.participants.find(x=>x.id===p.buyerId); if(!b) return;
            h+='<div class="purchase-card">'
               +'<div style="flex:1">'
               +'<div style="display:flex;justify-content:space-between;margin-bottom:8px">'
                 +'<span style="font-size:14px;color:var(--tg-theme-hint-color)">Купил: '+b.name+'</span>'
                 +'<span style="font-size:18px;font-weight:600;color:var(--tg-theme-link-color)">'+Math.round(p.price*p.quantity)+'₽</span>'
               +'</div>'
               +'<div style="font-size:16px;font-weight:500">'+p.item+'</div>'
               +'<div style="font-size:14px;color:var(--tg-theme-hint-color)">'+p.price+'₽ × '+p.quantity+' шт</div>'
               +'</div>'
               +'<button class="delete-btn" onclick="app.deletePurchase('+p.id+')">🗑️</button>'
               +'</div>';
          });
          h+='</div>'
            +'<div style="text-align:right;margin-top:12px;padding:12px;background:var(--tg-theme-secondary-bg-color);border-radius:12px">'
            +'<div style="font-size:14px;color:var(--tg-theme-hint-color)">Всего</div>'
            +'<div style="font-size:24px;font-weight:700;color:var(--tg-theme-link-color)">'+Math.round(tot)+'₽</div>'
            +'</div>';
        }
        document.getElementById('tab-purchases').innerHTML=h;
      },

      renderConsumption: function() {
        const grouped=this.getGroupedPurchases();
        let h='<div style="background:var(--tg-theme-secondary-bg-color);padding:12px;border-radius:12px;margin-bottom:12px">'
          +'<div style="font-size:14px;font-weight:500;margin-bottom:8px">Быстрое распределение:</div>'
          +'<div style="display:flex;gap:8px"><button class="btn-small" onclick="app.autoDistribute()">Все поровну</button>'
          +'<button class="btn-small" onclick="app.clearConsumption()">Очистить всё</button></div></div>'
          +'<div style="overflow-x:auto" class="consumption-table"><table style="width:100%;font-size:14px;border-collapse:collapse">'
          +'<thead><tr><th class="sticky-col" style="background:var(--tg-theme-secondary-bg-color);padding:10px 8px;text-align:left">Участник</th>';
        grouped.forEach(group=>{
          const st=this.getConsumptionStatus(group.key);
          let statusClass='status-ok', statusIcon='✓';
          if(st.status==='error'){ statusClass='status-error'; statusIcon='⚠'; }
          else if(st.status==='warn'){ statusClass='status-warn'; statusIcon='⚠'; }
          h+='<th style="background:var(--tg-theme-secondary-bg-color);padding:10px 8px;min-width:220px">'
            +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">'
            +'<span style="font-weight:600">'+group.item+' ('+group.price+'₽)</span>'
            +'<button class="btn-small" onclick="app.autoDistributePurchase(\''+group.key+'\')">Поровну</button></div>'
            +'<div class="'+statusClass+'" style="font-weight:normal;font-size:12px;margin-top:4px">'
            +statusIcon+' '+st.filled+' / '+st.total+' шт'
            +(st.status==='error'?' <strong>(перебор!)</strong>':(st.status==='warn'&&st.filled>0?' <strong>(недозаполнено)</strong>':''))
            +'</div></th>';
        });
        h+='</tr></thead><tbody>';
        this.data.participants.forEach(pa=>{
          h+='<tr><td class="sticky-col" style="padding:10px 8px;border-bottom:1px solid #e5e5ea;font-weight:600">'+pa.name+'</td>';
          grouped.forEach(group=>{
            const k=group.key+'-'+pa.id; const v=this.data.consumption[k]||0; const cnt=this.data.participants.length;
            h+='<td style="padding:10px 8px;border-bottom:1px solid #e5e5ea"><div style="display:flex;gap:8px;flex-wrap:wrap">'
              +'<input type="number" value="'+v+'" onchange="app.updateConsumption(\''+group.key+'\','+pa.id+',this.value)" step="0.01" style="width:70px;padding:8px;font-size:14px;border:1px solid #e5e5ea;border-radius:6px;text-align:center">'
              +'<select onchange="if(this.value){app.quickSet(\''+group.key+'\','+pa.id+',this.value,'+group.totalQuantity+','+cnt+');this.value='+"''"+'}" style="padding:6px;font-size:12px;border-radius:6px;border:1px solid #e5e5ea">'
              +'<option value="">Доля</option><option value="0">Не ел</option>';
            for(let d=cnt; d>=2; d--){ h+='<option value="1/'+d+'">1/'+d+'</option>'; }
            h+='<option value="all">Всё</option></select></div></td>';
          });
          h+='</tr>';
        });
        h+='</tbody></table></div>';
        document.getElementById('tab-consumption').innerHTML=h;
      },

      renderResults: function() {
        const r=this.calculateResults();
        const tr=this.calculateTransfers();
        let h='<div class="section"><div class="section-header">Баланс</div>';
        r.forEach(x=>{
          h+='<div class="result-card">'
            +'<div style="font-size:18px;font-weight:600;margin-bottom:8px">'+x.name+'</div>'
            +'<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:15px"><span style="color:var(--tg-theme-hint-color)">Потратил</span><span style="font-weight:600">'+Math.round(x.spent)+'₽</span></div>'
            +'<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:15px"><span style="color:var(--tg-theme-hint-color)">Должен</span><span style="font-weight:600">'+Math.round(x.shouldPay)+'₽</span></div>'
            +'<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:15px"><span style="color:var(--tg-theme-hint-color)">Баланс</span><span style="font-weight:600;color:'+(x.balance>=0?'#34C759':'#FF3B30')+'">'+(x.balance>=0?'+':'')+Math.round(x.balance)+'₽</span></div>'
          +'</div>';
        });
        h+='</div>';
        if(tr.length){
          h+='<div class="section" style="margin-top:16px"><div class="section-header">Переводы</div>';
          tr.forEach(t=>{
            h+='<div class="transfer-card"><div>'+t.from+' → '+t.to+'</div><div style="font-size:24px;font-weight:700;margin:8px 0">'+t.amount+'₽</div></div>';
          });
          h+='</div>';
        }
        h+='<div style="margin-top:16px"><button class="btn btn-secondary" onclick="app.exportResults()">📤 Поделиться результатами</button></div>';
        document.getElementById('tab-results').innerHTML=h;
      },

      renderHelp: function() {
        let h='<div class="section"><div class="section-header">Как пользоваться</div>';
        h+='<div class="faq-item"><div class="faq-question">📝 Шаг 1: Добавьте участников</div><div class="faq-answer">На вкладке "Участники" внесите имена всех, кто участвует в расчётах. Можно добавлять и удалять участников в любой момент.</div></div>';
        h+='<div class="faq-item"><div class="faq-question">🛒 Шаг 2: Внесите покупки</div><div class="faq-answer">На вкладке "Покупки" укажите, кто что купил: покупателя, товар, цену и количество.</div></div>';
        h+='<div class="faq-item"><div class="faq-question">🍕 Шаг 3: Распределите потребление</div><div class="faq-answer">На вкладке "Потребление" укажите, кто сколько потребил каждого товара. Можно распределить поровну или выбрать доли (1/2, 1/3 и т.д.).</div></div>';
        h+='<div class="faq-item"><div class="faq-question">💰 Шаг 4: Результаты</div><div class="faq-answer">На вкладке "Результаты" виден итоговый баланс каждого участника и список переводов.</div></div>';
        h+='</div>';
        h+='<div class="section" style="margin-top:16px"><div class="section-header">Полезные функции</div>';
        h+='<div class="faq-item"><div class="faq-question">⚡ Быстрое распределение</div><div class="faq-answer">Кнопка "Все поровну" распределит все товары между участниками в равных долях.</div></div>';
        h+='<div class="faq-item"><div class="faq-question">🎯 Контроль заполнения</div><div class="faq-answer">Индикаторы под названием товара показывают, распределено ли всё количество (зелёная галочка — ок, жёлтый — недозаполнено, красный — перебор).</div></div>';
        h+='<div class="faq-item"><div class="faq-question">💾 Автосохранение</div><div class="faq-answer">Все данные сохраняются локально в браузере. Можно закрыть приложение и вернуться позже.</div></div>';
        h+='<div class="faq-item"><div class="faq-question">🗑️ Сброс данных</div><div class="faq-answer">Кнопка "Сбросить все данные" на вкладке "Участники" очистит сохранённые данные.</div></div>';
        h+='</div>';
        h+='<div class="developer-card"><div style="font-size:20px;font-weight:600;margin-bottom:12px">👨‍💻 Разработчик</div><div style="font-size:18px;margin-bottom:8px">Владимир Васякин</div><div style="font-size:16px;opacity:0.9">📧 e@mailvladimir.ru</div><div style="margin-top:16px;font-size:14px;opacity:0.8">По вопросам и предложениям пишите на электронную почту</div></div>';
        document.getElementById('tab-help').innerHTML=h;
      }
    };

    window.onload = function() { app.init(); };
  </script>
  <script>
   if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("Service Worker зарегистрирован"));
  }
  </script>
 </body>
</html>
