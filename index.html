<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Party Calculator</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      padding-bottom: 20px;
    }
    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #999999;
      --tg-theme-link-color: #2481cc;
      --tg-theme-button-color: #2481cc;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #f4f4f5;
    }
    .header { background: var(--tg-theme-bg-color); padding: 12px 16px; border-bottom: 1px solid #e5e5ea; position: sticky; top: 0; z-index: 100; }
    .header-title { font-size: 17px; font-weight: 600; text-align: center; }
    .tabs { display: flex; background: var(--tg-theme-secondary-bg-color); border-bottom: 1px solid #e5e5ea; }
    .tab { flex: 1; padding: 12px; text-align: center; background: none; border: none; font-size: 15px; color: var(--tg-theme-hint-color); cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { color: var(--tg-theme-link-color); border-bottom-color: var(--tg-theme-link-color); font-weight: 500; }
    .content { padding: 16px; }
    .section { background: var(--tg-theme-bg-color); border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
    .section-header { padding: 12px 16px; background: var(--tg-theme-secondary-bg-color); font-size: 13px; font-weight: 600; color: var(--tg-theme-hint-color); text-transform: uppercase; }
    .list-item { padding: 12px 16px; border-bottom: 1px solid #e5e5ea; display: flex; align-items: center; gap: 12px; }
    .list-item:last-child { border-bottom: none; }
    .list-item-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--tg-theme-link-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .list-item-content { flex: 1; }
    .list-item-title { font-size: 16px; font-weight: 500; }
    .list-item-subtitle { font-size: 14px; color: var(--tg-theme-hint-color); }
    .purchase-card { background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 12px; margin: 8px; display: flex; gap: 12px; align-items: center; }
    .delete-btn { width: 36px; height: 36px; border-radius: 50%; background: #FF3B30; color: white; border: none; cursor: pointer; }
    .btn { padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); width: 100%; }
    .btn-small { padding: 6px 12px; font-size: 13px; border-radius: 6px; border: 1px solid #e5e5ea; background: var(--tg-theme-bg-color); cursor: pointer; }
    .form-input { width: 100%; padding: 12px; border: 1px solid #e5e5ea; border-radius: 10px; font-size: 16px; }
    .hidden { display: none; }
    .result-card { background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 16px; margin: 12px; }
    .transfer-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 16px; margin: 12px; text-align: center; }
    .status-ok { color: #34C759; font-weight: 600; }
    .status-warn { color: #FF9500; font-weight: 600; }
    .status-error { color: #FF3B30; font-weight: 600; }
  </style>
</head>
<body>
  <div class="header"><div class="header-title">Party Calculator</div></div>
  <div class="tabs">
    <button class="tab active" onclick="app.showTab('participants')">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
    <button class="tab" onclick="app.showTab('purchases')">–ü–æ–∫—É–ø–∫–∏</button>
    <button class="tab" onclick="app.showTab('consumption')">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</button>
    <button class="tab" onclick="app.showTab('results')">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
    <button class="tab" onclick="app.showTab('faq')">‚ùì</button>
  </div>
  <div class="content">
    <div id="tab-participants"></div>
    <div id="tab-purchases" class="hidden"></div>
    <div id="tab-consumption" class="hidden"></div>
    <div id="tab-results" class="hidden"></div>
    <div id="tab-faq" class="hidden"></div>
  </div>
  <script>
    const app = {
      data: { participants: [], purchases: [], consumption: {} },
      init() {
        this.loadData();
        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.ready();
          window.Telegram.WebApp.expand();
        }
        this.render();
      },
      loadData() {
        try {
          const saved = localStorage.getItem('partyCalcData');
          if (saved) {
            const data = JSON.parse(saved);
            if (data.participants !== undefined) {
              const validPurchases = data.purchases ? data.purchases.filter(p => {
                return data.participants.some(part => part.id === p.buyerId);
              }) : [];
              this.data.participants = data.participants || [];
              this.data.purchases = validPurchases;
              this.data.consumption = data.consumption || {};
              return;
            }
          }
        } catch(e) {
          console.error('Error loading data:', e);
          localStorage.clear();
        }
        this.data.participants = [];
        this.data.purchases = [];
        this.data.consumption = {};
        this.saveData();
      },
      saveData() { localStorage.setItem('partyCalcData', JSON.stringify(this.data)); },
      showTab(t) {
        ['participants','purchases','consumption','results','faq'].forEach(x => document.getElementById('tab-'+x).classList.add('hidden'));
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.target.classList.add('active');
      },
      addParticipant() {
        const v = document.getElementById('new-participant').value.trim();
        if (!v) return;
        this.data.participants.push({id:Date.now(),name:v});
        document.getElementById('new-participant').value = '';
        this.saveData(); this.render();
      },
      deleteParticipant(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
        this.data.participants = this.data.participants.filter(p => p.id !== id);
        this.saveData(); this.render();
      },
      addPurchase() {
        if (!this.data.participants.length) {
          alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤!');
          return;
        }
        const b = parseInt(document.getElementById('purchase-buyer').value);
        const i = document.getElementById('purchase-item').value;
        const p = parseFloat(document.getElementById('purchase-price').value);
        const q = parseFloat(document.getElementById('purchase-quantity').value) || 1;
        if (!i || !p) return;
        this.data.purchases.push({id:Date.now(),buyerId:b,item:i,price:p,quantity:q});
        document.getElementById('purchase-item').value = '';
        document.getElementById('purchase-price').value = '';
        document.getElementById('purchase-quantity').value = '1';
        this.saveData(); this.render();
      },
      deletePurchase(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
        this.data.purchases = this.data.purchases.filter(p => p.id !== id);
        this.saveData(); this.render();
      },
      updateConsumption(pid, uid, v) {
        const table = document.querySelector('.consumption-table');
        const scrollPos = table ? table.scrollLeft : 0;
        
        this.data.consumption[pid+'-'+uid] = parseFloat(v) || 0;
        this.saveData();
        this.render();
        
        requestAnimationFrame(() => {
          const newTable = document.querySelector('.consumption-table');
          if (newTable) newTable.scrollLeft = scrollPos;
        });
      },
      quickSet(pid, uid, f, tot, cnt) {
        const table = document.querySelector('.consumption-table');
        const scrollPos = table ? table.scrollLeft : 0;
        
        let v = 0;
        if (f === '0') v = 0;
        else if (f === 'all') v = tot;
        else if (f.includes('/')) {
          const [n,d] = f.split('/').map(Number);
          const alreadyDistributed = this.data.participants.reduce((sum, pa) => {
            if (pa.id === uid) return sum;
            return sum + (this.data.consumption[pid+'-'+pa.id] || 0);
          }, 0);
          const remaining = tot - alreadyDistributed;
          const exact = tot * n / d;
          v = Math.min(remaining, Math.round(exact * 100) / 100);
        }
        this.data.consumption[pid+'-'+uid] = v;
        this.saveData(); 
        this.render();
        
        requestAnimationFrame(() => {
          const newTable = document.querySelector('.consumption-table');
          if (newTable) newTable.scrollLeft = scrollPos;
        });
      },
      autoDistributePurchase(pid) {
        const pu = this.data.purchases.find(p => p.id === pid);
        if (!pu) return;
        const cnt = this.data.participants.length;
        const perPerson = pu.quantity / cnt;
        let distributed = 0;
        this.data.participants.forEach((pa, i) => {
          if (i === cnt - 1) {
            this.data.consumption[pu.id+'-'+pa.id] = Math.round((pu.quantity - distributed) * 100) / 100;
          } else {
            const share = Math.round(perPerson * 100) / 100;
            this.data.consumption[pu.id+'-'+pa.id] = share;
            distributed += share;
          }
        });
        this.saveData(); this.render();
      },
      autoDistribute() {
        if (!confirm('–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –í–°–ï –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ—Ä–æ–≤–Ω—É?')) return;
        this.data.consumption = {};
        this.data.purchases.forEach(pu => {
          const cnt = this.data.participants.length;
          const perPerson = pu.quantity / cnt;
          let distributed = 0;
          this.data.participants.forEach((pa, i) => {
            if (i === cnt - 1) {
              this.data.consumption[pu.id+'-'+pa.id] = Math.round((pu.quantity - distributed) * 100) / 100;
            } else {
              const share = Math.round(perPerson * 100) / 100;
              this.data.consumption[pu.id+'-'+pa.id] = share;
              distributed += share;
            }
          });
        });
        this.saveData(); this.render();
      },
      clearConsumption() {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è?')) return;
        this.data.consumption = {};
        this.saveData(); this.render();
      },
      resetAll() {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
        localStorage.clear();
        this.data = { participants: [], purchases: [], consumption: {} };
        this.saveData();
        this.render();
      },
      getConsumptionStatus(pid) {
        const pu = this.data.purchases.find(p => p.id === pid);
        if (!pu) return { filled: 0, total: 0, percent: 0, status: 'warn' };
        const filled = this.data.participants.reduce((sum, pa) => {
          const val = this.data.consumption[pid+'-'+pa.id];
          return sum + (val ? parseFloat(val) : 0);
        }, 0);
        const total = pu.quantity;
        const percent = (filled / total) * 100;
        let status = 'warn';
        if (percent > 100.5) status = 'error';
        else if (percent >= 99.5 && percent <= 100.5) status = 'ok';
        else status = 'warn';
        return { filled: Math.round(filled*100)/100, total, percent, status };
      },
      calculateResults() {
        return this.data.participants.map(pa => {
          const spent = this.data.purchases.filter(p => p.buyerId === pa.id).reduce((s,p) => s + p.price*p.quantity, 0);
          const shouldPay = this.data.purchases.reduce((s,pu) => s + (this.data.consumption[pu.id+'-'+pa.id]||0)*pu.price, 0);
          return {...pa, spent, shouldPay, balance: spent-shouldPay};
        });
      },
      calculateTransfers() {
        const r = this.calculateResults();
        const deb = r.filter(x => x.balance < 0).sort((a,b) => a.balance-b.balance);
        const cred = r.filter(x => x.balance > 0).sort((a,b) => b.balance-a.balance);
        const tr = [];
        let i=0,j=0;
        while (i < deb.length && j < cred.length) {
          const amt = Math.min(Math.abs(deb[i].balance), cred[j].balance);
          if (amt > 0.01) tr.push({from:deb[i].name,to:cred[j].name,amount:Math.round(amt)});
          deb[i].balance += amt; cred[j].balance -= amt;
          if (Math.abs(deb[i].balance) < 0.01) i++;
          if (Math.abs(cred[j].balance) < 0.01) j++;
        }
        return tr;
      },
      shareResults() {
        const results = this.calculateResults();
        const transfers = this.calculateTransfers();
        const totalSpent = this.data.purchases.reduce((s,p) => s + p.price*p.quantity, 0);
        
        let text = 'üéâ Party Calculator - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã\n\n';
        text += 'üí∞ –û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã: ' + Math.round(totalSpent) + '‚ÇΩ\n\n';
        text += 'üë• –ë–∞–ª–∞–Ω—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:\n';
        results.forEach(r => {
          const sign = r.balance >= 0 ? '+' : '';
          text += r.name + ': ' + sign + Math.round(r.balance) + '‚ÇΩ\n';
        });
        
        if (transfers.length > 0) {
          text += '\nüí∏ –ü–µ—Ä–µ–≤–æ–¥—ã:\n';
          transfers.forEach(t => {
            text += t.from + ' ‚Üí ' + t.to + ': ' + t.amount + '‚ÇΩ\n';
          });
        }
        
        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.showPopup({
            title: '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è',
            message: '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞',
            buttons: [{type: 'ok'}]
          });
        }
        
        if (navigator.share) {
          navigator.share({ text: text }).catch(() => {});
        } else if (navigator.clipboard) {
          navigator.clipboard.writeText(text);
        }
      },
      render() { this.renderParticipants(); this.renderPurchases(); this.renderConsumption(); this.renderResults(); this.renderFAQ(); },
      renderParticipants() {
        const r = this.calculateResults();
        let h = '<div class="section"><div class="section-header">–£—á–∞—Å—Ç–Ω–∏–∫–∏ ('+this.data.participants.length+')</div>';
        this.data.participants.forEach(p => {
          const res = r.find(x => x.id === p.id);
          h += '<div class="list-item"><div class="list-item-icon">'+p.name[0].toUpperCase()+'</div>';
          h += '<div class="list-item-content"><div class="list-item-title">'+p.name+'</div>';
          h += '<div class="list-item-subtitle">–ü–æ—Ç—Ä–∞—Ç–∏–ª '+Math.round(res.spent)+'‚ÇΩ</div></div>';
          h += '<div style="font-size:16px;font-weight:600;color:'+(res.balance>=0?'#34C759':'#FF3B30')+'">';
          h += (res.balance>=0?'+':'')+Math.round(res.balance)+'‚ÇΩ</div>';
          h += '<button class="delete-btn" onclick="app.deleteParticipant('+p.id+')">üóëÔ∏è</button></div>';
        });
        h += '</div><div style="display:flex;gap:8px;margin-top:12px">';
        h += '<input type="text" id="new-participant" class="form-input" placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞">';
        h += '<button class="btn btn-primary" style="width:auto;padding:12px 24px" onclick="app.addParticipant()">+</button></div>';
        h += '<div style="margin-top:12px;text-align:center">';
        h += '<button onclick="app.resetAll()" style="padding:8px 16px;background:#FF3B30;color:white;border:none;border-radius:8px;font-size:14px;cursor:pointer">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button></div>';
        document.getElementById('tab-participants').innerHTML = h;
      },
      renderPurchases() {
        const tot = this.data.purchases.reduce((s,p) => s + p.price*p.quantity, 0);
        let h = '<div class="section"><div class="section-header">–ù–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞</div><div style="padding:16px">';
        
        if (this.data.participants.length === 0) {
          h += '<div style="padding:20px;text-align:center;color:var(--tg-theme-hint-color)">';
          h += '–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–£—á–∞—Å—Ç–Ω–∏–∫–∏"</div>';
        } else {
          h += '<div style="margin-bottom:16px"><label style="display:block;font-size:14px;font-weight:500;margin-bottom:8px">–ö—Ç–æ –∫—É–ø–∏–ª?</label>';
          h += '<select id="purchase-buyer" class="form-input">';
          this.data.participants.forEach(p => h += '<option value="'+p.id+'">'+p.name+'</option>');
          h += '</select></div>';
          h += '<div style="margin-bottom:16px"><label style="display:block;font-size:14px;font-weight:500;margin-bottom:8px">–¢–æ–≤–∞—Ä</label>';
          h += '<input type="text" id="purchase-item" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∏–Ω–æ, –ü–∏—Ü—Ü–∞"></div>';
          h += '<div style="display:flex;gap:12px;margin-bottom:16px">';
          h += '<div style="flex:1"><label style="display:block;font-size:14px;font-weight:500;margin-bottom:8px">–¶–µ–Ω–∞</label>';
          h += '<input type="number" id="purchase-price" class="form-input" placeholder="0"></div>';
          h += '<div style="flex:1"><label style="display:block;font-size:14px;font-weight:500;margin-bottom:8px">–ö–æ–ª-–≤–æ</label>';
          h += '<input type="number" id="purchase-quantity" class="form-input" value="1" step="0.1"></div></div>';
          h += '<button class="btn btn-primary" onclick="app.addPurchase()">–î–æ–±–∞–≤–∏—Ç—å</button>';
        }
        h += '</div></div>';
        
        if (this.data.purchases.length > 0) {
          h += '<div class="section" style="margin-top:16px"><div class="section-header">–ü–æ–∫—É–ø–∫–∏ ('+this.data.purchases.length+')</div>';
          this.data.purchases.forEach(p => {
            const b = this.data.participants.find(x => x.id === p.buyerId);
            if (!b) return;
            h += '<div class="purchase-card"><div style="flex:1">';
            h += '<div style="display:flex;justify-content:space-between;margin-bottom:8px">';
            h += '<span style="font-size:14px;color:var(--tg-theme-hint-color)">–ö—É–ø–∏–ª: '+b.name+'</span>';
            h += '<span style="font-size:18px;font-weight:600;color:var(--tg-theme-link-color)">'+Math.round(p.price*p.quantity)+'‚ÇΩ</span></div>';
            h += '<div style="font-size:16px;font-weight:500">'+p.item+'</div>';
            h += '<div style="font-size:14px;color:var(--tg-theme-hint-color)">'+p.price+'‚ÇΩ √ó '+p.quantity+' —à—Ç</div></div>';
            h += '<button class="delete-btn" onclick="app.deletePurchase('+p.id+')">üóëÔ∏è</button></div>';
          });
          h += '</div>';
          h += '<div style="text-align:right;margin-top:12px;padding:12px;background:var(--tg-theme-secondary-bg-color);border-radius:12px">';
          h += '<div style="font-size:14px;color:var(--tg-theme-hint-color)">–í—Å–µ–≥–æ</div>';
          h += '<div style="font-size:24px;font-weight:700;color:var(--tg-theme-link-color)">'+Math.round(tot)+'‚ÇΩ</div></div>';
        }
        document.getElementById('tab-purchases').innerHTML = h;
      },
      renderConsumption() {
        let h = '<div style="background:var(--tg-theme-secondary-bg-color);padding:12px;border-radius:12px;margin-bottom:12px">';
        h += '<div style="font-size:14px;font-weight:500;margin-bottom:8px">–ë—ã—Å—Ç—Ä–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:</div>';
        h += '<div style="display:flex;gap:8px"><button class="btn-small" onclick="app.autoDistribute()">–í—Å–µ –ø–æ—Ä–æ–≤–Ω—É</button>';
        h += '<button class="btn-small" onclick="app.clearConsumption()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button></div></div>';
        h += '<div style="overflow-x:auto" class="consumption-table"><table style="width:100%;font-size:14px;border-collapse:collapse">';
        h += '<thead><tr><th style="background:var(--tg-theme-secondary-bg-color);padding:10px 8px;text-align:left;position:sticky;left:0;z-index:1">–£—á–∞—Å—Ç–Ω–∏–∫</th>';
        this.data.purchases.forEach(p => {
          const st = this.getConsumptionStatus(p.id);
          let statusClass = 'status-ok';
          let statusIcon = '‚úì';
          if (st.status === 'error') { statusClass = 'status-error'; statusIcon = '‚ö†'; }
          else if (st.status === 'warn') { statusClass = 'status-warn'; statusIcon = '‚ö†'; }
          h += '<th style="background:var(--tg-theme-secondary-bg-color);padding:10px 8px;min-width:220px">';
          h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
          h += '<span style="font-weight:600">'+p.item+'</span>';
          h += '<button class="btn-small" onclick="app.autoDistributePurchase('+p.id+')">–ü–æ—Ä–æ–≤–Ω—É</button></div>';
          h += '<div class="'+statusClass+'" style="font-weight:normal;font-size:12px;margin-top:4px">';
          h += statusIcon+' '+st.filled+' / '+st.total+' —à—Ç';
          if (st.status === 'error') h += ' <strong>(–ø–µ—Ä–µ–±–æ—Ä!)</strong>';
          else if (st.status === 'warn' && st.filled > 0) h += ' <strong>(–Ω–µ–¥–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ)</strong>';
          else if (st.status === 'warn' && st.filled === 0) h += '';
          h += '</div></th>';
        });
        h += '</tr></thead><tbody>';
        this.data.participants.forEach(pa => {
          h += '<tr><td style="padding:10px 8px;border-bottom:1px solid #e5e5ea;font-weight:600;position:sticky;left:0;background:var(--tg-theme-bg-color);z-index:1">'+pa.name+'</td>';
          this.data.purchases.forEach(pu => {
            const k = pu.id+'-'+pa.id;
            const v = this.data.consumption[k]||0;
            const cnt = this.data.participants.length;
            h += '<td style="padding:10px 8px;border-bottom:1px solid #e5e5ea"><div style="display:flex;gap:8px;flex-wrap:wrap">';
            h += '<input type="number" value="'+v+'" onchange="app.updateConsumption('+pu.id+','+pa.id+',this.value)" step="0.01" style="width:70px;padding:8px;font-size:14px;border:1px solid #e5e5ea;border-radius:6px;text-align:center">';
            h += '<select onchange="if(this.value){app.quickSet('+pu.id+','+pa.id+',this.value,'+pu.quantity+','+cnt+');this.value=\'\'}" style="padding:6px;font-size:12px;border-radius:6px;border:1px solid #e5e5ea">';
            h += '<option value="">–î–æ–ª—è</option><option value="0">–ù–µ –µ–ª</option>';
            for (let d = cnt; d >= 2; d--) {
              h += '<option value="1/'+d+'">1/'+d+'</option>';
            }
            h += '<option value="all">–í—Å—ë</option></select></div></td>';
          });
          h += '</tr>';
        });
        h += '</tbody></table></div>';
        document.getElementById('tab-consumption').innerHTML = h;
      },
      renderResults() {
        const r = this.calculateResults();
        const tr = this.calculateTransfers();
        let h = '<div class="section"><div class="section-header">–ë–∞–ª–∞–Ω—Å</div>';
        r.forEach(x => {
          h += '<div class="result-card"><div style="font-size:18px;font-weight:600;margin-bottom:8px">'+x.name+'</div>';
          h += '<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:15px">';
          h += '<span style="color:var(--tg-theme-hint-color)">–ü–æ—Ç—Ä–∞—Ç–∏–ª</span><span style="font-weight:600">'+Math.round(x.spent)+'‚ÇΩ</span></div>';
          h += '<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:15px">';
          h += '<span style="color:var(--tg-theme-hint-color)">–î–æ–ª–∂–µ–Ω</span><span style="font-weight:600">'+Math.round(x.shouldPay)+'‚ÇΩ</span></div>';
          h += '<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:15px">';
          h += '<span style="color:var(--tg-theme-hint-color)">–ë–∞–ª–∞–Ω—Å</span>';
          h += '<span style="font-weight:600;color:'+(x.balance>=0?'#34C759':'#FF3B30')+'">'+(x.balance>=0?'+':'')+Math.round(x.balance)+'‚ÇΩ</span></div></div>';
        });
        h += '</div>';
        if (tr.length) {
          h += '<div class="section" style="margin-top:16px"><div class="section-header">–ü–µ—Ä–µ–≤–æ–¥—ã</div>';
          tr.forEach(t => {
            h += '<div class="transfer-card"><div>'+t.from+' ‚Üí '+t.to+'</div>';
            h += '<div style="font-size:24px;font-weight:700;margin:8px 0">'+t.amount+'‚ÇΩ</div></div>';
          });
          h += '</div>';
          h += '<button class="btn btn-primary" style="margin-top:12px" onclick="app.shareResults()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏</button>';
        }
        document.getElementById('tab-results').innerHTML = h;
      },
      renderFAQ() {
        let h = '<div class="section"><div class="section-header">–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</div>';
        h += '<div style="padding:16px">';
        
        h += '<div style="margin-bottom:20px">';
        h += '<div style="font-size:16px;font-weight:600;margin-bottom:8px">1Ô∏è‚É£ –î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
        h += '<div style="font-size:14px;color:var(--tg-theme-hint-color);line-height:1.5">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–£—á–∞—Å—Ç–Ω–∏–∫–∏" –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤—Å–µ—Ö, –∫—Ç–æ –±—ã–ª –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫–µ. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —É–¥–∞–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.</div>';
        h += '</div>';
        
        h += '<div style="margin-bottom:20px">';
        h += '<div style="font-size:16px;font-weight:600;margin-bottom:8px">2Ô∏è‚É£ –í–Ω–µ—Å–∏—Ç–µ –ø–æ–∫—É–ø–∫–∏</div>';
        h += '<div style="font-size:14px;color:var(--tg-theme-hint-color);line-height:1.5">–ù–∞ –≤–∫–ª–∞–¥–∫–µ "–ü–æ–∫—É–ø–∫–∏" –¥–æ–±–∞–≤—å—Ç–µ –≤—Å—ë, —á—Ç–æ –±—ã–ª–æ –∫—É–ø–ª–µ–Ω–æ: –∫—Ç–æ –∫—É–ø–∏–ª, –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å—á–∏—Ç–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É.</div>';
        h += '</div>';
        
        h += '<div style="margin-bottom:20px">';
        h += '<div style="font-size:16px;font-weight:600;margin-bottom:8px">3Ô∏è‚É£ –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</div>';
        h += '<div style="font-size:14px;color:var(--tg-theme-hint-color);line-height:1.5">–ù–∞ –≤–∫–ª–∞–¥–∫–µ "–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ" —É–∫–∞–∂–∏—Ç–µ, –∫—Ç–æ —á—Ç–æ —Å—ä–µ–ª/–≤—ã–ø–∏–ª:<br>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ—Ä–æ–≤–Ω—É" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞<br>‚Ä¢ –ò–ª–∏ –≤—ã–±–∏—Ä–∞–π—Ç–µ –¥–æ–ª–∏ (1/3, 1/2 –∏ —Ç.–¥.)<br>‚Ä¢ –ò–ª–∏ –≤–≤–æ–¥–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ä—É—á–Ω—É—é</div>';
        h += '</div>';
        
        h += '<div style="margin-bottom:20px">';
        h += '<div style="font-size:16px;font-weight:600;margin-bottom:8px">üìä –¶–≤–µ—Ç–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</div>';
        h += '<div style="font-size:14px;color:var(--tg-theme-hint-color);line-height:1.5">';
        h += '<div style="margin-bottom:4px">üü¢ <strong style="color:#34C759">–ó–µ–ª—ë–Ω—ã–π</strong> - –≤—Å—ë —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ</div>';
        h += '<div style="margin-bottom:4px">üü° <strong style="color:#FF9500">–ñ—ë–ª—Ç—ã–π</strong> - –Ω–µ–¥–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ, –æ—Å—Ç–∞–ª–æ—Å—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å</div>';
        h += '<div>üî¥ <strong style="color:#FF3B30">–ö—Ä–∞—Å–Ω—ã–π</strong> - –æ—à–∏–±–∫–∞, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å</div>';
        h += '</div></div>';
        
        h += '<div style="margin-bottom:20px">';
        h += '<div style="font-size:16px;font-weight:600;margin-bottom:8px">4Ô∏è‚É£ –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>';
        h += '<div style="font-size:14px;color:var(--tg-theme-hint-color);line-height:1.5">–ù–∞ –≤–∫–ª–∞–¥–∫–µ "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã" —É–≤–∏–¥–∏—Ç–µ:<br>‚Ä¢ –ë–∞–ª–∞–Ω—Å –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞<br>‚Ä¢ –ö—Ç–æ –∫–æ–º—É –¥–æ–ª–∂–µ–Ω –∏ —Å–∫–æ–ª—å–∫–æ<br>‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤</div>';
        h += '</div>';
        
        h += '<div style="margin-bottom:20px">';
        h += '<div style="font-size:16px;font-weight:600;margin-bottom:8px">üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</div>';
        h += '<div style="font-size:14px;color:var(--tg-theme-hint-color);line-height:1.5">–í—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å.</div>';
        h += '</div>';
        
        h += '<div style="margin-bottom:20px">';
        h += '<div style="font-size:16px;font-weight:600;margin-bottom:8px">üîÑ –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>';
        h += '<div style="font-size:14px;color:var(--tg-theme-hint-color);line-height:1.5">–ù–∞ –≤–∫–ª–∞–¥–∫–µ "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã" –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Ç–æ–≥–∏ –¥—Ä—É–∑—å—è–º.</div>';
        h += '</div>';
        
        h += '<div style="background:var(--tg-theme-secondary-bg-color);padding:12px;border-radius:8px;margin-top:20px">';
        h += '<div style="font-size:14px;font-weight:600;margin-bottom:8px">üí° –°–æ–≤–µ—Ç</div>';
        h += '<div style="font-size:13px;color:var(--tg-theme-hint-color);line-height:1.5">–ó–∞–ø–æ–ª–Ω—è–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä—è–º–æ –≤–æ –≤—Ä–µ–º—è –≤–µ—á–µ—Ä–∏–Ω–∫–∏ - —Ç–∞–∫ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–±—É–¥–µ—Ç–µ!</div>';
        h += '</div>';
        
        h += '</div></div>';
        document.getElementById('tab-faq').innerHTML = h;
      }
    };
    window.onload = () => app.init();
  </script>
</body>
</html>
