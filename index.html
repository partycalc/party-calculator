<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Party Calculator</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      background:var(--tg-theme-bg-color,#0f172a);
      color:var(--tg-theme-text-color,#e5e7eb);
      -webkit-tap-highlight-color:transparent
    }
    :root{
      --tg-theme-bg-color:#0f172a;
      --tg-theme-text-color:#e5e7eb;
      --tg-theme-hint-color:#94a3b8;
      --tg-theme-link-color:#62aaff;
      --tg-theme-button-color:#3b82f6;
      --tg-theme-button-text-color:#fff;
      --tg-theme-secondary-bg-color:#0b1220;
    }

    .header{position:sticky;top:0;z-index:50;background:var(--tg-theme-bg-color);border-bottom:1px solid rgba(255,255,255,.06);padding:10px 16px;display:flex;justify-content:center}
    .header-title{font-size:17px;font-weight:700}

    .tabs-wrap{position:sticky;top:48px;z-index:49;background:var(--tg-theme-bg-color);border-bottom:1px solid rgba(255,255,255,.06)}
    .tabs{display:flex;overflow-x:auto;gap:2px;padding:0 8px;scrollbar-width:none}
    .tabs::-webkit-scrollbar{display:none}
    .tab{flex:0 0 auto;padding:12px 10px;background:none;border:none;border-bottom:2px solid transparent;color:inherit;opacity:.85;font-size:15px;font-weight:500;cursor:pointer;white-space:nowrap}
    .tab.active{color:var(--tg-theme-link-color);border-bottom-color:var(--tg-theme-link-color)}

    .content{padding:14px}
    .section{background:var(--tg-theme-secondary-bg-color);border-radius:16px;overflow:hidden;margin-bottom:12px;box-shadow:0 0 0 1px rgba(255,255,255,.06) inset}
    .section-header{padding:10px 14px;background:rgba(255,255,255,.04);color:#cbd5e1;text-transform:uppercase;font-weight:700;font-size:12px;letter-spacing:.02em}

    .row{display:flex;gap:8px;padding:10px}
    .col{flex:1}
    .input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:inherit;font-size:15px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:12px;padding:10px 14px;background:var(--tg-theme-button-color);color:var(--tg-theme-button-text-color);font-weight:700;cursor:pointer}
    .btn.secondary{background:rgba(255,255,255,.10);color:#e5e7eb}
    .btn.danger{background:#ef4444}
    .btn.small{padding:8px 10px;font-size:13px}

    .list{padding:8px 10px}
    .item{display:flex;align-items:flex-start;justify-content:space-between;padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.06);margin-bottom:8px;gap:12px;background:rgba(0,0,0,.1)}
    .item-title{font-weight:700}
    .item-sub{font-size:12px;color:var(--tg-theme-hint-color)}

    .table{width:100%;border-collapse:separate;border-spacing:0}
    .th,.td{border-bottom:1px solid rgba(255,255,255,.06);padding:10px}
    .th{font-size:12px;text-transform:uppercase;color:#94a3b8;background:rgba(255,255,255,.04);position:sticky;top:0;z-index:2}
    .sticky-left{position:sticky;left:0;background:var(--tg-theme-secondary-bg-color);z-index:1;border-right:1px solid rgba(255,255,255,.06)}

    .consumption-wrap{overflow-x:auto;border:1px solid rgba(255,255,255,.06);border-radius:16px}
    .qty-input{width:100%;padding:10px;border:1px solid rgba(255,255,255,.12);border-radius:10px;background:rgba(255,255,255,.06);color:inherit;text-align:center}
    .sum{font-weight:700}

    .hint{font-size:12px;color:var(--tg-theme-hint-color)}
    .link{color:var(--tg-theme-link-color);text-decoration:none}

    .results-card{border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px;margin-bottom:10px;background:rgba(0,0,0,.08)}
    .pos{color:#34d399;font-weight:700}
    .neg{color:#f87171;font-weight:700}

    /* DONATE modal */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:flex-end;z-index:60}
    .modal.show{display:flex}
    .sheet{background:var(--tg-theme-secondary-bg-color);border-radius:16px 16px 0 0;width:100%;padding:14px 14px 18px 14px;box-shadow:0 -8px 30px rgba(0,0,0,.4)}
    .sheet-title{font-weight:700;font-size:16px;margin-bottom:8px}
    .bank-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .bank-btn{border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;text-align:center;background:rgba(255,255,255,.06);color:#e5e7eb;cursor:pointer}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:rgba(255,255,255,.06);border:1px dashed rgba(255,255,255,.18);border-radius:12px;padding:10px 12px;margin-top:6px;color:#fff}

    /* –≤–∏–¥–∏–º—ã–π —Ç–µ–∫—Å—Ç/–∫–∞—Ä–µ—Ç–∫–∞/–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä */
    .input,.qty-input{color:var(--tg-theme-text-color)!important;caret-color:var(--tg-theme-button-color)}
    .input::placeholder,.qty-input::placeholder{color:var(--tg-theme-hint-color);opacity:.95}

    /* –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ: –∞–¥–∞–ø—Ç–∏–≤ */
    .consumption-desktop{display:block}
    .consumption-mobile{display:none}
    @media (max-width:520px){
      .consumption-desktop{display:none}
      .consumption-mobile{display:block}
      .consumption-mobile .item-title{margin-bottom:8px;display:block}
      .consumption-mobile .item{background:rgba(255,255,255,.04)}
    }
  </style>
</head>
<body>
  <div class="header"><div class="header-title">Party Calculator</div></div>
  <div class="tabs-wrap"><div class="tabs" id="tabs"></div></div>

  <div class="content">
    <div id="tab-participants"></div>
    <div id="tab-purchases" style="display:none"></div>
    <div id="tab-consumption" style="display:none"></div>
    <div id="tab-results" style="display:none"></div>
    <div id="tab-help" style="display:none"></div>
  </div>

  <!-- DONATE SHEET -->
  <div class="modal" id="donateModal">
    <div class="sheet">
      <div class="sheet-title">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É</div>
      <div class="hint">–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –°–ë–ü –Ω–∞ –Ω–æ–º–µ—Ä:</div>
      <div class="code" id="donatePhone">+7 903 398-01-17</div>
      <div class="row" style="padding:10px 0 0 0">
        <button class="btn small" id="copyDonate">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä</button>
        <button class="btn small secondary" id="closeDonate">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="mt-12 text-sm">–ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –±–∞–Ω–∫–∞:</div>
      <div class="bank-grid">
        <div class="bank-btn" id="vtbBtn">–í–¢–ë (–°–ë–ü)</div>
        <div class="bank-btn" id="anyBankBtn">–õ—é–±–æ–π –±–∞–Ω–∫ (–°–ë–ü)</div>
      </div>
      <div class="hint" style="margin-top:8px">–ï—Å–ª–∏ –±–∞–Ω–∫ –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à–µ –±–∞–Ω–∫–æ–≤—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Å–¥–µ–ª–∞–π—Ç–µ ¬´–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É (–°–ë–ü)¬ª.</div>
    </div>
  </div>

<script>
(function(){
  const LS_KEY = 'partycalc_v3';
  const CLOUD_PREFIX = 'pcv3_';
  const CLOUD_META = CLOUD_PREFIX + 'meta';
  const CLOUD_CHUNK = CLOUD_PREFIX + 'p';
  const CLOUD_CHUNK_SIZE = 3800;

  const DONATE_PHONE_RAW='79033980117';
  const DONATE_PHONE_VIEW='+7 903 398-01-17';
  const DEV_EMAIL='e@mailvladimir.ru';

  try{ if(window.Telegram&&Telegram.WebApp){ Telegram.WebApp.ready(); Telegram.WebApp.expand(); } }catch(_){}

  const uid=()=>Math.floor(Math.random()*1e9);
  // ‚ö†Ô∏è –ë–µ–∑ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ ¬´–Ø¬ª
  const DEFAULT={
    participants:[],
    purchases:[],
    consumption:{},
    activeTab:'participants',
    updatedAt: Date.now()
  };

  const APP={
    data: DEFAULT,
    _consScroll:0,
    _saveTimer:null,

    async init(){
      await this.loadPersisted();
      this.renderTabs();
      this.render();
      this.initDonate();
    },

    /* ---------- Persistence ---------- */
    cloudAvailable(){ return !!(window.Telegram && Telegram.WebApp && Telegram.WebApp.CloudStorage); },
    cloudGet(key){ return new Promise(res=>{ try{ Telegram.WebApp.CloudStorage.getItem(key,(e,v)=>res(e?null:v)); }catch(_){ res(null); } }); },
    cloudSet(key,val){ return new Promise(res=>{ try{ Telegram.WebApp.CloudStorage.setItem(key,String(val),()=>res(true)); }catch(_){ res(false); } }); },

    async cloudLoad(){
      if(!this.cloudAvailable()) return null;
      const metaStr = await this.cloudGet(CLOUD_META);
      if(!metaStr) return null;
      let meta; try{ meta=JSON.parse(metaStr); }catch(_){ return null; }
      const parts = +meta.parts || 0;
      if(parts<=0) return null;
      let json=''; 
      for(let i=0;i<parts;i++){
        const chunk = await this.cloudGet(CLOUD_CHUNK+i);
        if(chunk==null){ json=null; break; }
        json += chunk;
      }
      if(!json) return null;
      try{ return JSON.parse(json); }catch(_){ return null; }
    },

    async cloudSave(){
      if(!this.cloudAvailable()) return;
      const json = JSON.stringify(this.data);
      const parts = Math.ceil(json.length / CLOUD_CHUNK_SIZE);
      for(let i=0;i<parts;i++){
        const slice = json.slice(i*CLOUD_CHUNK_SIZE, (i+1)*CLOUD_CHUNK_SIZE);
        await this.cloudSet(CLOUD_CHUNK+i, slice);
      }
      await this.cloudSet(CLOUD_META, JSON.stringify({parts, ts:this.data.updatedAt}));
    },
    cloudSaveDebounced(){
      clearTimeout(this._saveTimer);
      this._saveTimer = setTimeout(()=>{ this.cloudSave().catch(()=>{}); }, 350);
    },

    async loadPersisted(){
      let local=null; try{ local=JSON.parse(localStorage.getItem(LS_KEY)||'null'); }catch(_){}
      const cloud = await this.cloudLoad();

      const candidates=[local,cloud,DEFAULT].filter(Boolean);
      candidates.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
      this.data = candidates[0] || DEFAULT;

      // –º–∏–≥—Ä–∞—Ü–∏—è: –µ—Å–ª–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è ¬´–Ø¬ª –∏ –ø–æ–∫—É–ø–æ–∫ –Ω–µ—Ç ‚Äî —É–±–∏—Ä–∞–µ–º
      if (Array.isArray(this.data.participants)
          && this.data.participants.length===1
          && (this.data.participants[0].name||'').trim().toLowerCase()==='—è'
          && (!Array.isArray(this.data.purchases) || this.data.purchases.length===0)) {
        this.data.participants = [];
      }

      if(!this.data.participants) this.data.participants=[];
      if(!this.data.purchases) this.data.purchases=[];
      if(!this.data.consumption) this.data.consumption={};
      if(!this.data.activeTab) this.data.activeTab='participants';
      if(!this.data.updatedAt) this.data.updatedAt=Date.now();

      try{ localStorage.setItem(LS_KEY, JSON.stringify(this.data)); }catch(_){}
    },

    saveData(){
      this.data.updatedAt = Date.now();
      try{ localStorage.setItem(LS_KEY, JSON.stringify(this.data)); }catch(_){}
      this.cloudSaveDebounced();
    },

    /* ---------- Tabs / Render ---------- */
    setTab(k){ this.data.activeTab=k; this.saveData(); this.renderTabs(); this.syncTabs(); this.render(); },
    renderTabs(){
      const tabs=[['participants','–£—á–∞—Å—Ç–Ω–∏–∫–∏'],['purchases','–ü–æ–∫—É–ø–∫–∏'],['consumption','–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ'],['results','–†–µ–∑—É–ª—å—Ç–∞—Ç—ã'],['help','–ü–æ–º–æ—â—å']];
      const el=document.getElementById('tabs'); el.innerHTML='';
      tabs.forEach(([k,l])=>{ const b=document.createElement('button'); b.className='tab'+(this.data.activeTab===k?' active':''); b.textContent=l; b.onclick=()=>this.setTab(k); el.appendChild(b); });
    },
    syncTabs(){ ['participants','purchases','consumption','results','help'].forEach(k=>{ document.getElementById('tab-'+k).style.display=(this.data.activeTab===k)?'block':'none'; }); },
    render(){
      this.renderParticipants();
      this.renderPurchases();
      this.renderConsumption();
      this.renderResults();
      this.renderHelp();
    },

    /* ---------- Participants ---------- */
    renderParticipants(){
      const h=[];
      h.push('<div class="section"><div class="section-header">–£—á–∞—Å—Ç–Ω–∏–∫–∏ ('+this.data.participants.length+')</div>');
      h.push('<div class="row"><div class="col"><input class="input" id="newPartName" placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞"/></div><div class="flex gap-8"><button class="btn" id="addPart">–î–æ–±–∞–≤–∏—Ç—å</button><button class="btn secondary" id="resetAll">–°–±—Ä–æ—Å–∏—Ç—å</button></div></div>');
      h.push('<div class="list">');
      if(this.data.participants.length===0){
        h.push('<div class="item"><div class="hint">–ù–∞—á–Ω–∏—Ç–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</div></div>');
      } else {
        this.data.participants.forEach(p=>{
          h.push('<div class="item"><div><div class="item-title">'+escapeHTML(p.name)+'</div></div><div class="flex gap-8"><button class="btn small secondary" data-edit="'+p.id+'">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button><button class="btn small danger" data-del="'+p.id+'">–£–¥–∞–ª–∏—Ç—å</button></div></div>');
        });
      }
      h.push('</div></div>');
      const root=document.getElementById('tab-participants'); root.innerHTML=h.join('');

      document.getElementById('addPart').onclick=()=>{
        const v=document.getElementById('newPartName').value.trim(); if(!v) return;
        this.data.participants.push({id:uid(),name:v}); this.saveData(); this.render();
      };
      const resetBtn=document.getElementById('resetAll');
      if(resetBtn) resetBtn.onclick=()=>{ if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?'))return; try{ localStorage.removeItem(LS_KEY);}catch(_){} this.data=JSON.parse(JSON.stringify(DEFAULT)); this.saveData(); this.setTab('participants'); };

      root.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>{
        const id=+b.getAttribute('data-edit'); const p=this.data.participants.find(x=>x.id===id); if(!p) return;
        const v=prompt('–ù–æ–≤–æ–µ –∏–º—è',p.name); if(v&&v.trim()){ p.name=v.trim(); this.saveData(); this.render(); }
      });
      root.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{
        const id=+b.getAttribute('data-del');
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) return;
        this.data.participants=this.data.participants.filter(x=>x.id!==id);
        this.data.purchases.forEach(it=>{ if(it.payerId===id) it.payerId=(this.data.participants[0]||{}).id; });
        const next={}; Object.keys(this.data.consumption).forEach(k=>{ const pid=+k.split('-')[1]; if(pid!==id) next[k]=this.data.consumption[k];}); this.data.consumption=next;
        this.saveData(); this.render();
      });
    },

    /* ---------- Purchases ---------- */
    renderPurchases(){
      const parts=this.data.participants; const h=[];
      h.push('<div class="section"><div class="section-header">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É</div>');
      h.push('<div class="row"><div class="col"><input class="input" id="newItemTitle" placeholder="–¢–æ–≤–∞—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–∏—Ü—Ü–∞)"/></div><div style="width:110px"><input class="input" id="newItemAmt" placeholder="–¶–µ–Ω–∞, ‚ÇΩ" inputmode="decimal"/></div><div style="width:160px"><select class="input" id="newItemPayer"><option value="">–ö—Ç–æ –ø–ª–∞—Ç–∏–ª</option>');
      parts.forEach(p=>h.push('<option value="'+p.id+'">'+escapeHTML(p.name)+'</option>'));
      h.push('</select></div><div><button class="btn" id="addItem">–î–æ–±–∞–≤–∏—Ç—å</button></div></div>');

      h.push('<div class="section-header" style="border-top:1px solid rgba(255,255,255,.06)">–ü–æ–∫—É–ø–∫–∏ ('+this.data.purchases.length+')</div><div class="list">');
      if(this.data.purchases.length===0){
        h.push('<div class="item"><div class="hint">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div></div>');
      } else {
        this.data.purchases.forEach(it=>{
          const payer=parts.find(p=>p.id===it.payerId);
          h.push('<div class="item"><div><div class="item-title">'+escapeHTML(it.title)+'</div><div class="item-sub">–ö—É–ø–∏–ª: '+(payer?escapeHTML(payer.name):'‚Äî')+'</div></div><div class="flex gap-8"><div class="item-title">'+fmt(it.amount)+'</div><button class="btn small secondary" data-edit="'+it.id+'">–ò–∑–º–µ–Ω–∏—Ç—å</button><button class="btn small danger" data-del="'+it.id+'">–£–¥–∞–ª–∏—Ç—å</button></div></div>');
        });
      }
      h.push('</div></div>');
      const root=document.getElementById('tab-purchases'); root.innerHTML=h.join('');

      document.getElementById('addItem').onclick=()=>{
        const t=document.getElementById('newItemTitle').value.trim();
        const a=parseNumber(document.getElementById('newItemAmt').value);
        const payerId=+document.getElementById('newItemPayer').value;
        if(parts.length===0) return alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.');
        if(!t) return alert('–£–∫–∞–∂–∏ —Ç–æ–≤–∞—Ä.'); if(isNaN(a)||a<=0) return alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞.'); if(!payerId) return alert('–í—ã–±–µ—Ä–∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞.');
        this.data.purchases.push({id:uid(),title:t,amount:a,payerId}); this.saveData(); this.render();
      };

      root.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{
        const id=+b.getAttribute('data-del'); if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–∫—É–ø–∫—É?'))return;
        this.data.purchases=this.data.purchases.filter(x=>x.id!==id);
        const next={}; Object.keys(this.data.consumption).forEach(k=>{ if(+k.split('-')[0]!==id) next[k]=this.data.consumption[k];}); this.data.consumption=next;
        this.saveData(); this.render();
      });

      root.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>{
        const id=+b.getAttribute('data-edit'); const it=this.data.purchases.find(x=>x.id===id); if(!it) return;
        const t=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ',it.title) ?? it.title;
        const a=parseNumber(prompt('–¶–µ–Ω–∞, ‚ÇΩ',String(it.amount)) ?? it.amount);
        const payerName=prompt('–ü–ª–∞—Ç–µ–ª—å—â–∏–∫ (–∏–º—è, –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)','');
        let payerId=it.payerId;
        if(payerName && payerName.trim()){
          const found=parts.find(p=>p.name.toLowerCase()===payerName.trim().toLowerCase());
          if(found) payerId=found.id; else alert('–¢–∞–∫–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–µ—Ç. –ü–ª–∞—Ç–µ–ª—å—â–∏–∫ –Ω–µ –∏–∑–º–µ–Ω—ë–Ω.');
        }
        if(t&&t.trim()) it.title=t.trim();
        if(!isNaN(a)&&a>0) it.amount=a;
        it.payerId=payerId; this.saveData(); this.render();
      });
    },

    /* ---------- Consumption ---------- */
    renderConsumption(){
      const parts=this.data.participants, items=this.data.purchases, root=document.getElementById('tab-consumption');

      const cols=parts.map(p=>'<th class="th">'+escapeHTML(p.name)+'</th>').join('');
      let table='<div class="section consumption-desktop"><div class="section-header">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–æ –ø–æ–∑–∏—Ü–∏—è–º</div><div class="consumption-wrap"><table class="table"><thead><tr><th class="th sticky-left">–ü–æ–∑–∏—Ü–∏—è</th>'+cols+'<th class="th">–ò—Ç–æ–≥–æ</th></tr></thead><tbody>';
      items.forEach(it=>{
        let row='<tr>';
        row+='<td class="td sticky-left"><div class="item-title">'+escapeHTML(it.title)+'</div><div class="item-sub">–°—É–º–º–∞: '+fmt(it.amount)+'</div></td>';
        let sumRow=0;
        parts.forEach(p=>{
          const key=`${it.id}-${p.id}`, val=+this.data.consumption[key]||0; sumRow+=val;
          row+=`<td class="td"><input class="qty-input" data-key="${key}" type="number" inputmode="decimal" placeholder="0" value="${val||''}" onchange="APP.updateConsumption(${it.id},${p.id},this.value,this)"></td>`;
        });
        row+='<td class="td sum">'+(sumRow||0)+'</td></tr>'; table+=row;
      });
      if(items.length===0) table+='<tr><td class="td sticky-left" colspan="'+(parts.length+2)+'"><span class="hint">–î–æ–±–∞–≤—å—Ç–µ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–ü–æ–∫—É–ø–∫–∏¬ª, –∑–∞—Ç–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ.</span></td></tr>';
      table+='</tbody></table></div></div>';

      let cards='<div class="section consumption-mobile"><div class="section-header">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</div><div class="list">';
      if(items.length===0) cards+='<div class="item"><div class="hint">–î–æ–±–∞–≤—å—Ç–µ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–ü–æ–∫—É–ø–∫–∏¬ª.</div></div>';
      else items.forEach(it=>{
        let inner='<div class="item-sub">–°—É–º–º–∞: '+fmt(it.amount)+'</div>';
        inner+='<div class="mt-8" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
        parts.forEach(p=>{
          const key=`${it.id}-${p.id}`, val=+this.data.consumption[key]||0;
          inner+=`<div><div class="item-sub" style="margin-bottom:4px">${escapeHTML(p.name)}</div><input class="qty-input" data-key="${key}" type="number" inputmode="decimal" placeholder="0" value="${val||''}" onchange="APP.updateConsumption(${it.id},${p.id},this.value,this)"></div>`;
        });
        inner+='</div>';
        cards+=`<div class="item"><div style="flex:1"><div class="item-title">${escapeHTML(it.title)}</div>${inner}</div></div>`;
      });
      cards+='</div></div>';

      root.innerHTML=table+cards;

      const wrap=root.querySelector('.consumption-wrap');
      if(wrap && typeof this._consScroll==='number') wrap.scrollLeft=this._consScroll;
      if(wrap && !this._consScrollListenerAdded){ wrap.addEventListener('scroll',()=>{this._consScroll=wrap.scrollLeft;},{passive:true}); this._consScrollListenerAdded=true; }
    },

    updateConsumption(itemId,partId,v,el){
      const wrap=document.querySelector('#tab-consumption .consumption-wrap');
      const saved=wrap?wrap.scrollLeft:0;
      const selS=el&&typeof el.selectionStart==='number'?el.selectionStart:null;
      const selE=el&&typeof el.selectionEnd==='number'?el.selectionEnd:null;

      const key=`${itemId}-${partId}`; const num=parseNumber(v);
      this.data.consumption[key]=isNaN(num)?0:num; this.saveData(); this.renderConsumption();

      requestAnimationFrame(()=>{
        const wrap2=document.querySelector('#tab-consumption .consumption-wrap'); if(wrap2) wrap2.scrollLeft=saved;
        const input2=document.querySelector(`input.qty-input[data-key="${key}"]`);
        if(input2){ input2.focus(); try{ if(selS!==null&&selE!==null) input2.setSelectionRange(selS,selE);}catch(_){} }
      });
    },

    /* ---------- Results ---------- */
    calculateResults(){
      const parts=this.data.participants, items=this.data.purchases, cons=this.data.consumption;
      const paid=Object.fromEntries(parts.map(p=>[p.id,0])); items.forEach(it=>{ if(paid[it.payerId]!=null) paid[it.payerId]+=it.amount; });
      const share=Object.fromEntries(parts.map(p=>[p.id,0]));
      items.forEach(it=>{
        let sum=0; parts.forEach(p=>{ sum+=(+cons[`${it.id}-${p.id}`]||0); });
        if(sum>0) parts.forEach(p=>{ const w=(+cons[`${it.id}-${p.id}`]||0); share[p.id]+=it.amount*(w/sum); });
        else { const n=parts.length||1; parts.forEach(p=>{ share[p.id]+=it.amount/n; }); }
      });
      const bal=Object.fromEntries(parts.map(p=>[p.id,+(paid[p.id]-share[p.id]).toFixed(2)]));

      const creditors=[],debtors=[];
      parts.forEach(p=>{ const b=+bal[p.id].toFixed(2); if(b>0) creditors.push({id:p.id,name:p.name,amt:b}); else if(b<0) debtors.push({id:p.id,name:p.name,amt:-b}); });
      creditors.sort((a,b)=>b.amt-a.amt); debtors.sort((a,b)=>b.amt-a.amt);
      const transfers=[]; let i=0,j=0;
      while(i<debtors.length&&j<creditors.length){
        const d=debtors[i],c=creditors[j]; const pay=+Math.min(d.amt,c.amt).toFixed(2);
        transfers.push({from:d,to:c,amt:pay}); d.amt=+(d.amt-pay).toFixed(2); c.amt=+(c.amt-pay).toFixed(2);
        if(d.amt<=0.009) i++; if(c.amt<=0.009) j++;
      }
      return {paid,share,bal,transfers};
    },

    renderResults(){
      const r=this.calculateResults(), parts=this.data.participants;
      const root=document.getElementById('tab-results');
      let h='<div class="section"><div class="section-header">–ò—Ç–æ–≥–∏ –∏ –≤–∑–∞–∏–º–æ—Ä–∞—Å—á—ë—Ç—ã</div><div class="list" id="results-capture">';
      if(parts.length===0){
        h+='<div class="item"><div class="hint">–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –ø–æ–∫—É–ø–∫–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ç–æ–≥–∏.</div></div>';
      }else{
        parts.forEach(p=>{
          const b=+r.bal[p.id];
          h+='<div class="results-card"><div class="item-title">'+escapeHTML(p.name)+'</div>';
          h+='<div class="item-sub">–û–ø–ª–∞—Ç–∏–ª: '+fmt(r.paid[p.id])+' | –ï–≥–æ –¥–æ–ª—è: '+fmt(r.share[p.id])+'</div>';
          h+='<div class="'+(b>=0?'pos':'neg')+'">–ë–∞–ª–∞–Ω—Å: '+fmt(b)+'</div></div>';
        });
      }
      h+='<div class="section-header" style="margin:12px -14px 0 -14px">–ö—Ç–æ –∫–æ–º—É –ø–µ—Ä–µ–≤–æ–¥–∏—Ç</div><div class="list">';
      if(r.transfers.length===0) h+='<div class="item"><div>–ù–∏–∫—Ç–æ –Ω–∏–∫–æ–º—É –Ω–µ –¥–æ–ª–∂–µ–Ω üéâ</div></div>';
      else r.transfers.forEach(t=>{ h+='<div class="item"><div>'+escapeHTML(t.from.name)+' ‚Üí '+escapeHTML(t.to.name)+'</div><div class="sum">'+fmt(t.amt)+'</div></div>'; });
      h+='</div>';
      h+='<div class="row" style="padding:12px 10px"><button class="btn" id="btnSavePng">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG</button><button class="btn secondary" id="btnShare">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button></div>';
      h+='</div></div>';
      root.innerHTML=h;

      document.getElementById('btnSavePng').onclick=()=>this.saveResultsAsImage();
      document.getElementById('btnShare').onclick=()=>this.shareResults();
    },

    saveResultsAsImage(){
      const node=document.getElementById('results-capture'); if(!node) return alert('–ù–µ –Ω–∞–π–¥–µ–Ω –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
      const bg=getComputedStyle(document.body).backgroundColor || '#ffffff';
      html2canvas(node,{scale:2,backgroundColor:bg,useCORS:true,removeContainer:true,windowWidth:document.documentElement.scrollWidth})
      .then(canvas=>{
        if(canvas.toBlob){
          canvas.toBlob(blob=>{
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a'); a.href=url; a.download='party-result.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          });
        }else{
          const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='party-result.png'; a.click();
        }
      }).catch(()=>alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É.'));
    },

    shareResults(){
      const r=this.calculateResults(), parts=this.data.participants;
      let text='–ò—Ç–æ–≥–∏ Party Calculator:\n\n';
      parts.forEach(p=>{
        const b=+r.bal[p.id];
        text+=`${p.name}: –æ–ø–ª–∞—Ç–∏–ª ${fmt(r.paid[p.id])}, –¥–æ–ª—è ${fmt(r.share[p.id])}, –±–∞–ª–∞–Ω—Å ${fmt(b)}\n`;
      });
      if(r.transfers.length){
        text+='\n–ü–µ—Ä–µ–≤–æ–¥—ã:\n';
        r.transfers.forEach(t=>{ text+=`‚Ä¢ ${t.from.name} ‚Üí ${t.to.name}: ${fmt(t.amt)}\n`; });
      }else{
        text+='\n–ù–∏–∫—Ç–æ –Ω–∏–∫–æ–º—É –Ω–µ –¥–æ–ª–∂–µ–Ω üéâ\n';
      }

      if(navigator.share){
        navigator.share({text}).catch(()=>this.copyText(text));
      }else{
        this.copyText(text);
      }
    },
    copyText(t){
      navigator.clipboard?.writeText(t).then(()=>alert('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –∏ –≤—Å—Ç–∞–≤—å—Ç–µ.')).catch(()=>alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: '+t));
    },

    /* ---------- Help ---------- */
    renderHelp(){
      const h=`
        <div class="section">
          <div class="section-header">–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</div>
          <div class="list">
            <div class="item"><div><div class="item-title">üìù –®–∞–≥ 1: –î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div><div class="item-sub">–í–æ –≤–∫–ª–∞–¥–∫–µ ¬´–£—á–∞—Å—Ç–Ω–∏–∫–∏¬ª –≤–Ω–µ—Å–∏—Ç–µ –∏–º–µ–Ω–∞ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —É–¥–∞–ª—è—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.</div></div></div>
            <div class="item"><div><div class="item-title">üõí –®–∞–≥ 2: –í–Ω–µ—Å–∏—Ç–µ –ø–æ–∫—É–ø–∫–∏</div><div class="item-sub">–£–∫–∞–∂–∏—Ç–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è, —Ç–æ–≤–∞—Ä –∏ —Ü–µ–Ω—É.</div></div></div>
            <div class="item"><div><div class="item-title">üçï –®–∞–≥ 3: –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</div><div class="item-sub">–í ¬´–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏¬ª —É–∫–∞–∂–∏—Ç–µ –∫—Ç–æ —Å–∫–æ–ª—å–∫–æ —Å—ä–µ–ª/–≤—ã–ø–∏–ª, –ª–∏–±–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–æ—Ä–æ–≤–Ω—É.</div></div></div>
            <div class="item"><div><div class="item-title">üí∞ –®–∞–≥ 4: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div><div class="item-sub">–ë–∞–ª–∞–Ω—Å –ø–æ –∫–∞–∂–¥–æ–º—É –∏ —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–≤–æ–¥–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG¬ª –∏–ª–∏ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª.</div></div></div>

            <div class="item" style="background:linear-gradient(135deg,#5b7cff,#9d6bff);color:#fff">
              <div style="flex:1">
                <div class="item-title">üë®‚Äçüíª –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</div>
                <div class="item-sub" style="color:#eaf2ff">–í–ª–∞–¥–∏–º–∏—Ä –í–∞—Å—è–∫–∏–Ω</div>
                <div class="item-sub"><a class="link" href="#" id="devEmailLink" style="color:#fff;text-decoration:underline">e@mailvladimir.ru</a></div>
                <div class="item-sub" style="color:#eaf2ff">–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º ‚Äî –ø–∏—à–∏—Ç–µ –Ω–∞ –ø–æ—á—Ç—É</div>
              </div>
              <button class="btn small secondary" id="openDonate2" style="background:rgba(255,255,255,.2);color:#fff">–î–æ–Ω–∞—Ç</button>
            </div>
          </div>
        </div>`;
      const root=document.getElementById('tab-help'); root.innerHTML=h;
      document.getElementById('openDonate2').onclick=()=>this.showDonateModal(true);
      document.getElementById('devEmailLink').onclick=(e)=>{ e.preventDefault(); this.openMail(); };
    },

    /* ---------- Donate / SBP ---------- */
    initDonate(){
      const modal=document.getElementById('donateModal');
      modal?.addEventListener('click',(e)=>{ if(e.target===modal) this.showDonateModal(false); });
      const closeBtn=document.getElementById('closeDonate'); closeBtn && (closeBtn.onclick=()=>this.showDonateModal(false));

      const copyBtn=document.getElementById('copyDonate');
      copyBtn && (copyBtn.onclick=async()=>{ try{ await navigator.clipboard.writeText(DONATE_PHONE_RAW); alert('–ù–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: '+DONATE_PHONE_VIEW);}catch{ alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é: '+DONATE_PHONE_VIEW);} });

      const anyBtn=document.getElementById('anyBankBtn');
      anyBtn && (anyBtn.onclick=()=>{ alert('–í –≤–∞—à–µ–º –±–∞–Ω–∫–µ –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É (–°–ë–ü)¬ª –∏ –≤—Å—Ç–∞–≤—å—Ç–µ: '+DONATE_PHONE_VIEW); });

      const vtbBtn=document.getElementById('vtbBtn'); vtbBtn && (vtbBtn.onclick=()=>this.tryVTB());
    },
    showDonateModal(show){ const m=document.getElementById('donateModal'); if(!m) return; m.classList.toggle('show',!!show); },

    openUrl(url){
      try{ if(window.Telegram?.WebApp?.openLink){ Telegram.WebApp.openLink(url); return; } }catch(_){}
      const w=window.open(url,'_blank'); if(!w) location.href=url;
    },

    tryVTB(){
      const phone=DONATE_PHONE_RAW;
      const candidates=[
        'vtb://sbp?phone='+phone,
        'vtb://pay?phone='+phone,
        'intent://sbp?phone='+phone+'#Intent;scheme=vtb;package=ru.vtb24.mobilebanking.android;end',
        'intent://pay?phone='+phone+'#Intent;scheme=sbp;package=ru.vtb24.mobilebanking.android;end'
      ];
      let opened=false;
      for(const u of candidates){ try{ this.openUrl(u); opened=true; break; }catch(_){} }
      setTimeout(()=>{ if(!opened) this.openUrl('https://www.vtb.ru/personal/servisy/sistema-bystryh-platezhey/'); alert('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –í–¢–ë ‚Üí ¬´–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É (–°–ë–ü)¬ª ‚Üí –≤—Å—Ç–∞–≤—å—Ç–µ '+DONATE_PHONE_VIEW); },600);
    },

    openMail(){
      const mailto=`mailto:${encodeURIComponent(DEV_EMAIL)}?subject=${encodeURIComponent('Party Calculator ‚Äî –≤–æ–ø—Ä–æ—Å/–∏–¥–µ—è')}`;
      try{
        if(window.Telegram?.WebApp?.openLink){ Telegram.WebApp.openLink(mailto); return; }
      }catch(_){}
      const w=window.open(mailto,'_blank');
      if(!w){
        navigator.clipboard?.writeText(DEV_EMAIL);
        alert('–ï—Å–ª–∏ –ø–æ—á—Ç–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å ‚Äî –∞–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: '+DEV_EMAIL);
      }
    }
  };

  /* ---------- Helpers ---------- */
  function parseNumber(v){ if(typeof v==='number') return v; if(!v) return NaN; const s=String(v).replace(',', '.').replace(/\s+/g,''); return parseFloat(s); }
  function fmt(n){ const s=(typeof n==='number'?n:parseNumber(n)); if(isNaN(s)) return '‚Äî'; return s.toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  window.APP=APP; window.onload=()=>APP.init();
})();
</script>
</body>
</html>
